import{u as Y,r as l,j as e,D as A,P as Z,m as _,g as k,d as j,e as i,p as $,k as S,x as ee,y as se,s as te}from"./index-szRe9_7c.js";import{M as U}from"./Modal-BWnk_ifJ.js";import{D as ae,a as O}from"./DropdownMenu-Cy-YUqPb.js";const ie=()=>{const{hasPermission:C}=Y(),[I,P]=l.useState([]),[b,B]=l.useState([]),[D,R]=l.useState([]),[q,M]=l.useState(!0),[c,d]=l.useState(null),[n,m]=l.useState([]),[F,u]=l.useState(!1),[L,f]=l.useState(!1),[o,x]=l.useState({}),[p,E]=l.useState(!1),[h,N]=l.useState(""),g="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white",y=async()=>{M(!0),d(null);try{const[s,t,r]=await Promise.all([k(j(i,"users")),k(j(i,"roles")),k(j(i,"warehouses"))]);P(s.docs.map(a=>({uid:a.id,...a.data()}))),B(t.docs.map(a=>({id:a.id,...a.data()}))),R(r.docs.map(a=>({id:a.id,...a.data()})))}catch(s){d("Impossible de charger les données."),console.error(s)}finally{M(!1)}};l.useEffect(()=>{y()},[]);const W=()=>{var s;E(!1),x({roleId:(s=b[0])==null?void 0:s.id,warehouseIds:[]}),N(""),d(null),f(!0)},z=s=>{E(!0),x(s),N(""),d(null),f(!0)},w=()=>f(!1),v=s=>{const{name:t,value:r}=s.target;x(a=>({...a,[t]:r}))},G=s=>{const t=o.warehouseIds||[],r=t.includes(s)?t.filter(a=>a!==s):[...t,s];x(a=>({...a,warehouseIds:r}))},T=async s=>{s.preventDefault(),d(null);const t={...o};if(h&&(t.password=h),!t.username||!t.displayName||!t.roleId){d("Veuillez remplir tous les champs obligatoires.");return}try{if(p){const{uid:r,...a}=t;await ee(S(i,"users",r),a)}else{if(!h){d("Le mot de passe est obligatoire pour un nouvel utilisateur.");return}await se(j(i,"users"),t)}await y(),w()}catch(r){d("Erreur lors de l'enregistrement de l'utilisateur."),console.error(r)}},V=async s=>{if(window.confirm("Êtes-vous sûr de vouloir supprimer cet utilisateur ?"))try{await $(S(i,"users",s)),await y()}catch{d("Erreur lors de la suppression.")}},H=async()=>{const s=te(i);n.forEach(t=>{s.delete(S(i,"users",t))}),await s.commit(),await y(),m([]),u(!1)},J=s=>{m(t=>t.includes(s)?t.filter(r=>r!==s):[...t,s])},K=s=>{s.target.checked?m(I.map(t=>t.uid)):m([])},Q=s=>{var t;return((t=b.find(r=>r.id===s))==null?void 0:t.name)||"N/A"},X=(s=[])=>s.map(t=>{var r;return(r=D.find(a=>a.id===t))==null?void 0:r.name}).filter(Boolean).join(", ")||"Aucun";return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:"Gestion des Utilisateurs"}),C("users")&&e.jsxs("div",{className:"flex items-center space-x-2",children:[n.length>0&&e.jsxs("button",{onClick:()=>u(!0),className:"flex items-center px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700",children:[e.jsx(A,{className:"w-5 h-5 mr-2"}),"Supprimer (",n.length,")"]}),e.jsxs("button",{onClick:W,className:"flex items-center px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700",children:[e.jsx(Z,{className:"w-5 h-5 mr-2"}),"Ajouter un utilisateur"]})]})]}),q?e.jsx("p",{children:"Chargement..."}):c?e.jsx("p",{className:"text-red-500",children:c}):e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow-lg rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-primary-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3",children:e.jsx("input",{type:"checkbox",onChange:K,className:"h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500"})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Nom Complet"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Nom d'utilisateur"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Rôle"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Entrepôts"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-bold text-white uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:I.map(s=>e.jsxs("tr",{className:n.includes(s.uid)?"bg-primary-50 dark:bg-gray-700/50":"",children:[e.jsx("td",{className:"px-4 py-4",children:e.jsx("input",{type:"checkbox",checked:n.includes(s.uid),onChange:()=>J(s.uid),className:"h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500"})}),e.jsx("td",{className:"px-6 py-4",children:s.displayName}),e.jsx("td",{className:"px-6 py-4",children:s.username}),e.jsx("td",{className:"px-6 py-4",children:Q(s.roleId)}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-500 dark:text-gray-400",children:X(s.warehouseIds)}),e.jsx("td",{className:"px-6 py-4 text-right",children:C("users")&&e.jsxs(ae,{children:[e.jsxs(O,{onClick:()=>z(s),children:[e.jsx(_,{className:"w-4 h-4 mr-3"})," Modifier"]}),e.jsxs(O,{onClick:()=>V(s.uid),className:"text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300",children:[e.jsx(A,{className:"w-4 h-4 mr-3"})," Supprimer"]})]})})]},s.uid))})]})}),e.jsx(U,{isOpen:L,onClose:w,title:p?"Modifier l'Utilisateur":"Ajouter un Utilisateur",children:e.jsxs("form",{onSubmit:T,children:[e.jsxs("div",{className:"p-6 space-y-4",children:[c&&e.jsx("p",{className:"text-red-500 bg-red-100 dark:bg-red-900/40 p-2 rounded-md text-sm",children:c}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Nom complet"}),e.jsx("input",{type:"text",name:"displayName",value:o.displayName||"",onChange:v,required:!0,className:g})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Nom d'utilisateur"}),e.jsx("input",{type:"text",name:"username",value:o.username||"",onChange:v,required:!0,className:g})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:p?"Nouveau mot de passe":"Mot de passe"}),e.jsx("input",{type:"password",placeholder:p?"Laisser vide pour ne pas changer":"",value:h,onChange:s=>N(s.target.value),className:g})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Rôle"}),e.jsx("select",{name:"roleId",value:o.roleId||"",onChange:v,required:!0,className:g,children:b.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Entrepôts Assignés"}),e.jsx("div",{className:"grid grid-cols-2 gap-2 mt-2 border p-2 rounded max-h-40 overflow-y-auto dark:border-gray-600",children:D.map(s=>e.jsx("div",{className:"text-sm",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:(o.warehouseIds||[]).includes(s.id),onChange:()=>G(s.id),className:"mr-2"})," ",s.name]})},s.id))})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse",children:[e.jsx("button",{type:"submit",className:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 sm:ml-3 sm:w-auto sm:text-sm",children:"Sauvegarder"}),e.jsx("button",{type:"button",onClick:w,className:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-500 shadow-sm px-4 py-2 bg-white dark:bg-gray-600 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-500 sm:mt-0 sm:w-auto sm:text-sm",children:"Annuler"})]})]})}),e.jsxs(U,{isOpen:F,onClose:()=>u(!1),title:"Confirmer la suppression",children:[e.jsx("div",{className:"p-6",children:e.jsxs("p",{children:["Êtes-vous sûr de vouloir supprimer les ",n.length," utilisateurs sélectionnés ?"]})}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse",children:[e.jsx("button",{onClick:H,className:"bg-red-600 text-white px-4 py-2 rounded",children:"Supprimer"}),e.jsx("button",{onClick:()=>u(!1),className:"ml-2 px-4 py-2 bg-gray-200 rounded",children:"Annuler"})]})]})]})};export{ie as default};
