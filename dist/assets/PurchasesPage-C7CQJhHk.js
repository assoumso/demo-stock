import{u as we,b as Ne,r,j as e,D as Y,P as ve,m as Se,z as Pe,B as ke,N as Ie,U as De,q as Z,d as v,e as x,o as Ce,g as L,w as Ae,l as ee,k as O,O as Te,Q as Ee,V as Me,X as Fe}from"./index-szRe9_7c.js";import{M as te}from"./Modal-BWnk_ifJ.js";import{P as Re}from"./Pagination-CsLxWpMj.js";import{D as Le,a as $}from"./DropdownMenu-Cy-YUqPb.js";const Ve=()=>{const{user:y}=we(),B=Ne(),[q,se]=r.useState([]),[_,ae]=r.useState([]),[U,ne]=r.useState([]),[z,G]=r.useState(!0),[S,u]=r.useState(null),[h,P]=r.useState(null),[g,k]=r.useState([]),[re,I]=r.useState(!1),[b,H]=r.useState(1),D=10,[l,le]=r.useState({startDate:"",endDate:"",warehouseId:"all",supplierId:"all",paymentStatus:"all",searchTerm:""}),[de,C]=r.useState(!1),[i,ie]=r.useState(null),[Q,ce]=r.useState([]),[c,w]=r.useState({amount:0,method:"Espèces",date:new Date().toISOString().split("T")[0],attachmentFile:null}),[X,J]=r.useState(!1),A=async()=>{z||G(!0),u(null);try{const t=Z(v(x,"purchases"),Ce("date","desc")),[s,n,o]=await Promise.all([L(t),L(v(x,"suppliers")),L(v(x,"warehouses"))]);se(s.docs.map(a=>({id:a.id,...a.data()}))),ae(n.docs.map(a=>({id:a.id,...a.data()}))),ne(o.docs.map(a=>({id:a.id,...a.data()})))}catch(t){console.error("Error fetching purchases data:",t),u("Impossible de charger les données des achats.")}finally{G(!1)}};r.useEffect(()=>{A()},[]),r.useEffect(()=>{H(1)},[l]),r.useEffect(()=>{k([])},[b]);const V=r.useMemo(()=>y?y.role.name.toLowerCase().includes("admin")?U:U.filter(t=>{var s;return(s=y.warehouseIds)==null?void 0:s.includes(t.id)}):[],[y,U]),T=r.useMemo(()=>q.filter(t=>{if(!V.map(j=>j.id).includes(t.warehouseId))return!1;const n=l.searchTerm===""||t.referenceNumber.toLowerCase().includes(l.searchTerm.toLowerCase()),o=l.supplierId==="all"||t.supplierId===l.supplierId,a=l.warehouseId==="all"||t.warehouseId===l.warehouseId,m=l.paymentStatus==="all"||t.paymentStatus===l.paymentStatus;let d=!0;return l.startDate&&(d=d&&new Date(t.date)>=new Date(l.startDate)),l.endDate&&(d=d&&new Date(t.date)<=new Date(l.endDate)),n&&o&&a&&m&&d}),[q,l,V]),E=r.useMemo(()=>T.slice((b-1)*D,b*D),[T,b]),oe=Math.ceil(T.length/D),me=t=>{var s;return((s=_.find(n=>n.id===t))==null?void 0:s.name)||"N/A"},M=t=>{const{name:s,value:n}=t.target;le(o=>({...o,[s]:n}))},ue=t=>k(s=>s.includes(t)?s.filter(n=>n!==t):[...s,t]),he=t=>k(t.target.checked?E.map(s=>s.id):[]),K=async t=>{if(!(h||!window.confirm(`Supprimer l'achat ${t.referenceNumber} ? Le stock sera restitué si l'achat était "Reçu".`))){P(t.id),u(null);try{await ee(x,async s=>{const n=O(x,"purchases",t.id),o=await s.get(n);if(!o.exists())throw new Error("Achat déjà supprimé.");const a=o.data(),m=[];if(a.purchaseStatus==="Reçu"&&a.items.length>0){const d=a.items.map(p=>O(x,"products",p.productId));(await Promise.all(d.map(p=>s.get(p)))).forEach((p,F)=>{if(p.exists()){const N=[...p.data().stockLevels||[]],R=N.findIndex(be=>be.warehouseId===a.warehouseId);R!==-1&&(N[R].quantity-=a.items[F].quantity,N[R].quantity<0&&(N[R].quantity=0),m.push({ref:d[F],stockLevels:N}))}})}m.forEach(d=>s.update(d.ref,{stockLevels:d.stockLevels})),s.delete(n)}),await A()}catch(s){u(`Erreur de suppression: ${s.message}.`)}finally{P(null)}}},xe=async()=>{if(window.confirm(`Supprimer les ${g.length} achats sélectionnés ?`)){I(!1),P("bulk-delete"),u(null);for(const t of g){const s=q.find(n=>n.id===t);s&&(await K(s),await new Promise(n=>setTimeout(n,500)))}await A(),k([]),P(null)}},pe=async t=>{ie(t),u(null);try{const n=Z(v(x,"purchasePayments"),Ae("purchaseId","==",t.id)),a=(await L(n)).docs.map(m=>({id:m.id,...m.data()}));a.sort((m,d)=>new Date(d.date).getTime()-new Date(m.date).getTime()),ce(a)}catch{u("Impossible de charger les paiements.")}const s=t.grandTotal-t.paidAmount;w({amount:s>0?s:0,method:"Espèces",date:new Date().toISOString().split("T")[0],attachmentFile:null}),C(!0)},ge=async t=>{if(t.preventDefault(),!i||c.amount<=0||!y)return u("Montant invalide.");const s=i.grandTotal-i.paidAmount;if(c.amount>s+.01)return u("Le paiement dépasse le solde.");J(!0),u(null);try{let n;if(c.attachmentFile){const a=Te(Ee,`purchase_payments/${i.id}/${Date.now()}_${c.attachmentFile.name}`);await Me(a,c.attachmentFile),n=await Fe(a)}const o=O(x,"purchases",i.id);await ee(x,async a=>{const m=await a.get(o);if(!m.exists())throw new Error("Achat introuvable.");const d=m.data(),j=d.paidAmount+c.amount;let p=j>=d.grandTotal-.01?"Payé":"Partiel";j===0&&(p="En attente"),a.update(o,{paidAmount:j,paymentStatus:p});const F={purchaseId:i.id,date:new Date(c.date).toISOString(),amount:c.amount,method:c.method,createdByUserId:y.uid,...n&&{attachmentUrl:n}};a.set(O(v(x,"purchasePayments")),F)}),await A(),C(!1)}catch(n){u(`Erreur: ${n.message}`)}finally{J(!1)}},f=t=>new Intl.NumberFormat("fr-FR").format(t)+" FCFA",fe=E.length>0&&g.length===E.length,ye=t=>({Payé:"bg-green-100 text-green-800",Partiel:"bg-blue-100 text-blue-800","En attente":"bg-yellow-100 text-yellow-800"})[t]||"",je=t=>({Reçu:"bg-green-100 text-green-800",Commandé:"bg-blue-100 text-blue-800","En attente":"bg-yellow-100 text-yellow-800"})[t]||"",W=i?i.grandTotal-i.paidAmount:0;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:"Liste des Achats"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[g.length>0&&e.jsxs("button",{onClick:()=>I(!0),disabled:!!h,className:"flex items-center px-4 py-2 text-sm text-white bg-red-600 rounded-md hover:bg-red-700 disabled:bg-red-300",children:[e.jsx(Y,{className:"w-5 h-5 mr-2"}),"Supprimer (",g.length,")"]}),e.jsxs("button",{onClick:()=>B("/purchases/new"),disabled:!!h,className:"flex items-center px-4 py-2 text-sm text-white bg-primary-600 rounded-md hover:bg-primary-700 disabled:bg-primary-300",children:[e.jsx(ve,{className:"w-5 h-5 mr-2"}),"Ajouter un Achat"]})]})]}),e.jsx("div",{className:"mb-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx("input",{type:"text",placeholder:"Rechercher par Réf...",name:"searchTerm",value:l.searchTerm,onChange:M,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700"}),e.jsxs("select",{name:"supplierId",value:l.supplierId,onChange:M,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:"all",children:"Tous les fournisseurs"}),_.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{name:"warehouseId",value:l.warehouseId,onChange:M,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:"all",children:"Tous les entrepôts"}),V.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{name:"paymentStatus",value:l.paymentStatus,onChange:M,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:"all",children:"Tous les paiements"}),e.jsx("option",{value:"Payé",children:"Payé"}),e.jsx("option",{value:"Partiel",children:"Partiel"}),e.jsx("option",{value:"En attente",children:"En attente"})]})]})}),z?e.jsx("p",{children:"Chargement..."}):S?e.jsx("p",{className:"text-red-500",children:S}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow-lg rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-primary-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3",children:e.jsx("input",{type:"checkbox",onChange:he,checked:fe,disabled:!!h})}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Référence"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Fournisseur"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Total"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Payé"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Solde"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Paiement"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Statut Achat"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-bold text-white uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700",children:E.map(t=>e.jsxs("tr",{className:g.includes(t.id)?"bg-primary-50 dark:bg-gray-700/50":"",children:[e.jsx("td",{className:"px-4 py-4",children:e.jsx("input",{type:"checkbox",checked:g.includes(t.id),onChange:()=>ue(t.id),disabled:!!h})}),e.jsx("td",{className:"px-6 py-4",children:t.referenceNumber}),e.jsx("td",{className:"px-6 py-4",children:me(t.supplierId)}),e.jsx("td",{className:"px-6 py-4",children:new Date(t.date).toLocaleDateString("fr-FR")}),e.jsx("td",{className:"px-6 py-4",children:f(t.grandTotal)}),e.jsx("td",{className:"px-6 py-4",children:f(t.paidAmount)}),e.jsx("td",{className:"px-6 py-4 font-bold text-red-600",children:f(t.grandTotal-t.paidAmount)}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:`px-2 inline-flex text-xs font-semibold rounded-full ${ye(t.paymentStatus)}`,children:t.paymentStatus})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:`px-2 inline-flex text-xs font-semibold rounded-full ${je(t.purchaseStatus)}`,children:t.purchaseStatus})}),e.jsx("td",{className:"px-6 py-4 text-right",children:h===t.id?e.jsxs("svg",{className:"animate-spin h-5 w-5 text-primary-500 mx-auto",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):e.jsxs(Le,{children:[e.jsxs($,{onClick:()=>B(`/purchases/edit/${t.id}`),disabled:!!h,children:[e.jsx(Se,{className:"w-4 h-4 mr-3"})," Modifier"]}),e.jsxs($,{onClick:()=>pe(t),disabled:!!h,children:[e.jsx(Pe,{className:"w-4 h-4 mr-3"})," Gérer paiements"]}),e.jsxs($,{onClick:()=>B(`/purchases/invoice/${t.id}`),disabled:!!h,children:[e.jsx(ke,{className:"w-4 h-4 mr-3"})," Voir la facture"]}),e.jsxs($,{onClick:()=>K(t),className:"text-red-600",disabled:!!h,children:[e.jsx(Y,{className:"w-4 h-4 mr-3"})," Supprimer"]})]})})]},t.id))})]})}),e.jsx(Re,{currentPage:b,totalPages:oe,onPageChange:H,totalItems:T.length,itemsPerPage:D})]}),e.jsxs(te,{isOpen:re,onClose:()=>I(!1),title:"Confirmer la suppression",children:[e.jsx("div",{className:"p-6",children:e.jsxs("p",{children:["Supprimer les ",g.length," achats sélectionnés ?"]})}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 px-4 py-3 flex flex-row-reverse",children:[e.jsx("button",{onClick:xe,className:"px-4 py-2 bg-red-600 text-white rounded",children:"Confirmer"}),e.jsx("button",{onClick:()=>I(!1),className:"mr-2 px-4 py-2 bg-gray-200 rounded",children:"Annuler"})]})]}),e.jsx(te,{isOpen:de,onClose:()=>C(!1),title:`Paiements pour l'Achat ${i==null?void 0:i.referenceNumber}`,children:i&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("span",{className:"block text-xs text-gray-500",children:"Total"}),e.jsx("span",{className:"text-lg font-bold",children:f(i.grandTotal)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-xs text-gray-500",children:"Payé"}),e.jsx("span",{className:"text-lg font-bold text-green-600",children:f(i.paidAmount)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-xs text-gray-500",children:"Solde"}),e.jsx("span",{className:"text-lg font-bold text-red-600",children:f(W)})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Historique"}),e.jsx("div",{className:"max-h-40 overflow-y-auto",children:Q.length>0?e.jsx("ul",{className:"divide-y dark:divide-gray-700",children:Q.map(t=>e.jsxs("li",{className:"py-2 flex justify-between",children:[e.jsxs("div",{children:[e.jsxs("span",{children:[new Date(t.date).toLocaleDateString("fr-FR")," - ",t.method]}),e.jsx("span",{className:"block font-medium",children:f(t.amount)})]}),t.attachmentUrl&&e.jsx("a",{href:t.attachmentUrl,target:"_blank",rel:"noopener noreferrer",className:"text-primary-600",children:e.jsx(Ie,{className:"w-5 h-5"})})]},t.id))}):e.jsx("p",{children:"Aucun paiement."})})]}),W>.01&&e.jsxs("form",{onSubmit:ge,className:"border-t pt-4 space-y-3",children:[e.jsx("h3",{className:"font-semibold",children:"Ajouter un paiement"}),S&&e.jsx("p",{className:"text-sm text-red-500",children:S}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Montant"}),e.jsx("input",{type:"number",step:"any",min:"0.01",max:W,value:c.amount,onChange:t=>w(s=>({...s,amount:parseFloat(t.target.value)||0})),required:!0,className:"w-full border rounded p-2 dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Méthode"}),e.jsxs("select",{value:c.method,onChange:t=>w(s=>({...s,method:t.target.value})),className:"w-full border rounded p-2 dark:bg-gray-700",children:[e.jsx("option",{children:"Espèces"}),e.jsx("option",{children:"Virement bancaire"}),e.jsx("option",{children:"Autre"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Date"}),e.jsx("input",{type:"date",value:c.date,onChange:t=>w(s=>({...s,date:t.target.value})),required:!0,className:"w-full border rounded p-2 dark:bg-gray-700"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Pièce jointe"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed rounded-md",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx(De,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("div",{className:"flex text-sm",children:e.jsxs("label",{htmlFor:"file-upload",className:"relative cursor-pointer rounded-md font-medium text-primary-600",children:[e.jsx("span",{children:"Télécharger un fichier"}),e.jsx("input",{id:"file-upload",type:"file",className:"sr-only",onChange:t=>w(s=>({...s,attachmentFile:t.target.files?t.target.files[0]:null}))})]})}),c.attachmentFile&&e.jsx("p",{className:"text-xs",children:c.attachmentFile.name})]})})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse -mx-6 -mb-6 mt-6",children:[e.jsx("button",{type:"submit",disabled:X,className:"px-4 py-2 bg-primary-600 text-white rounded",children:X?"Ajout...":"Ajouter Paiement"}),e.jsx("button",{type:"button",onClick:()=>C(!1),className:"mr-2 px-4 py-2 bg-gray-200 rounded",children:"Annuler"})]})]})]})})})]})};export{Ve as default};
