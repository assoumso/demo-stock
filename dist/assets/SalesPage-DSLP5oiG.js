import{u as me,b as pe,r,j as t,P as he,m as xe,z as ge,B as ye,D as fe,q as z,d as x,e as i,o as we,g,f as be,w as je,l as ke,k as G}from"./index-szRe9_7c.js";import{P as Ne}from"./Pagination-CsLxWpMj.js";import{D as Se,a as N}from"./DropdownMenu-Cy-YUqPb.js";const Ae=()=>{const{user:y}=me(),S=pe(),[E,J]=r.useState([]),[F,Q]=r.useState([]),[v,U]=r.useState([]),[H,K]=r.useState([]),[L,A]=r.useState(!0),[ve,u]=r.useState(null),[D,R]=r.useState(null),[m,I]=r.useState([]),[De,X]=r.useState(!1),[p,O]=r.useState(1),f=10,[n,Y]=r.useState({startDate:"",endDate:"",warehouseId:"all",customerId:"all",paymentStatus:"all",searchTerm:""}),[Ie,Z]=r.useState(!1),[P,ee]=r.useState(null),[Pe,B]=r.useState([]),[Ce,te]=r.useState({amount:0,method:"Espèces",date:new Date().toISOString().split("T")[0],attachmentFile:null}),[Te,Me]=r.useState(!1),$=async()=>{L||A(!0),u(null);try{const e=z(x(i,"sales"),we("date","desc")),[s,d,c,l]=await Promise.all([g(e),g(x(i,"customers")),g(x(i,"warehouses")),g(x(i,"products"))]);J(s.docs.map(a=>({id:a.id,...a.data()}))),Q(d.docs.map(a=>({id:a.id,...a.data()}))),U(c.docs.map(a=>({id:a.id,...a.data()}))),K(l.docs.map(a=>({id:a.id,...a.data()})))}catch(e){console.error("Error fetching sales data:",e),u("Impossible de charger les données des ventes.")}finally{A(!1)}};r.useEffect(()=>{$()},[]),r.useEffect(()=>{O(1)},[n]),r.useEffect(()=>{I([])},[p]);const C=r.useMemo(()=>y?y.role.name.toLowerCase().includes("admin")?v:v.filter(e=>{var s;return(s=y.warehouseIds)==null?void 0:s.includes(e.id)}):[],[y,v]),w=r.useMemo(()=>E.filter(e=>{if(!C.map(k=>k.id).includes(e.warehouseId))return!1;const d=n.searchTerm===""||e.referenceNumber.toLowerCase().includes(n.searchTerm.toLowerCase()),c=n.customerId==="all"||e.customerId===n.customerId,l=n.warehouseId==="all"||e.warehouseId===n.warehouseId,a=n.paymentStatus==="all"||e.paymentStatus===n.paymentStatus;let o=!0;return n.startDate&&(o=o&&new Date(e.date)>=new Date(n.startDate)),n.endDate&&(o=o&&new Date(e.date)<=new Date(n.endDate)),d&&c&&l&&a&&o}),[E,n,C]),b=r.useMemo(()=>w.slice((p-1)*f,p*f),[w,p]),se=Math.ceil(w.length/f),ae=e=>{var s;return((s=F.find(d=>d.id===e))==null?void 0:s.name)||"N/A"},j=e=>{const{name:s,value:d}=e.target;Y(c=>({...c,[s]:d}))},re=e=>I(s=>s.includes(e)?s.filter(d=>d!==e):[...s,e]),ne=e=>I(e.target.checked?b.map(s=>s.id):[]),ce=async e=>{const s=e.items.some(c=>{var l;return((l=H.find(a=>a.id===c.productId))==null?void 0:l.type)==="product"});let d=`Supprimer la vente ${e.referenceNumber} ?`;if(s&&e.saleStatus==="Complétée"&&(d+=" Le stock sera restitué."),!(D||!window.confirm(d))){R(e.id);try{await ke(i,async c=>{var V;const l=G(i,"sales",e.id),a=await c.get(l);if(!a.exists())throw new Error("Vente déjà supprimée.");const o=a.data(),k=[];if(o.saleStatus==="Complétée"&&((V=o.items)==null?void 0:V.length)>0)for(const h of o.items){const W=G(i,"products",h.productId),T=await c.get(W);if(T.exists()&&T.data().type!=="service"){const M=[...T.data().stockLevels||[]],_=M.findIndex(ue=>ue.warehouseId===o.warehouseId);_!==-1&&(M[_].quantity+=h.quantity,k.push({ref:W,newStockLevels:M}))}}for(const h of k)c.update(h.ref,{stockLevels:h.newStockLevels});c.delete(l)}),await $()}catch(c){u(`Erreur: ${c.message}`)}finally{R(null)}}},de=e=>{if(!e.paymentDueDate||e.paymentStatus==="Payé")return null;const s=new Date,d=new Date(e.paymentDueDate),c=Math.ceil((d.getTime()-s.getTime())/(1e3*3600*24));return c<0?t.jsxs("span",{className:"flex items-center text-[10px] font-black text-red-600 uppercase",children:[t.jsx(be,{className:"w-3 h-3 mr-1"})," Retard"]}):t.jsxs("span",{className:"text-[10px] text-gray-500 uppercase font-black",children:["J-",c]})},le=async e=>{ee(e),u(null);try{const d=z(x(i,"salePayments"),je("saleId","==",e.id)),l=(await g(d)).docs.map(a=>({id:a.id,...a.data()}));l.sort((a,o)=>new Date(o.date).getTime()-new Date(a.date).getTime()),B(l)}catch{B([]),u("Erreur chargement paiements.")}const s=e.grandTotal-e.paidAmount;te({amount:s>0?s:0,method:"Espèces",date:new Date().toISOString().split("T")[0],attachmentFile:null}),Z(!0)},q=e=>new Intl.NumberFormat("fr-FR").format(e)+" FCFA",oe=b.length>0&&m.length===b.length,ie=e=>({Payé:"bg-green-100 text-green-800",Partiel:"bg-blue-100 text-blue-800","En attente":"bg-yellow-100 text-yellow-800"})[e]||"";return P&&P.grandTotal-P.paidAmount,t.jsxs("div",{className:"pb-10",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white uppercase tracking-tight",children:"Liste des Ventes"}),t.jsxs("div",{className:"flex items-center space-x-2",children:[m.length>0&&t.jsxs("button",{onClick:()=>X(!0),disabled:!!D,className:"flex items-center px-4 py-2 text-sm text-white bg-red-600 rounded-md hover:bg-red-700 disabled:opacity-50 font-bold uppercase text-xs",children:["Supprimer (",m.length,")"]}),t.jsxs("button",{onClick:()=>S("/sales/new"),disabled:!!D,className:"flex items-center px-4 py-2 text-sm text-white bg-primary-600 rounded-md hover:bg-primary-700 disabled:opacity-50 font-bold uppercase text-xs",children:[t.jsx(he,{className:"w-5 h-5 mr-2"}),"Nouvelle Vente"]})]})]}),t.jsx("div",{className:"mb-4 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border dark:border-gray-700",children:t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[t.jsx("input",{type:"text",placeholder:"Réf. Vente...",name:"searchTerm",value:n.searchTerm,onChange:j,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 outline-none focus:ring-2 focus:ring-primary-500 transition-all"}),t.jsxs("select",{name:"customerId",value:n.customerId,onChange:j,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600",children:[t.jsx("option",{value:"all",children:"Tous les clients"}),F.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{name:"warehouseId",value:n.warehouseId,onChange:j,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600",children:[t.jsx("option",{value:"all",children:"Tous les entrepôts"}),C.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{name:"paymentStatus",value:n.paymentStatus,onChange:j,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600",children:[t.jsx("option",{value:"all",children:"Statut Paiement"}),t.jsx("option",{value:"Payé",children:"Payé"}),t.jsx("option",{value:"Partiel",children:"Partiel"}),t.jsx("option",{value:"En attente",children:"En attente"})]})]})}),L?t.jsx("p",{className:"text-center py-10 text-gray-500 font-bold animate-pulse",children:"Chargement des ventes..."}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"bg-white dark:bg-gray-800 shadow-xl rounded-2xl border dark:border-gray-700 overflow-hidden",children:t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[t.jsx("thead",{className:"bg-primary-600",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 w-10 text-center",children:t.jsx("input",{type:"checkbox",className:"h-4 w-4 text-primary-900 border-white rounded",checked:oe,onChange:ne})}),t.jsx("th",{className:"px-6 py-3 text-left text-[10px] font-black text-white uppercase tracking-widest",children:"Référence"}),t.jsx("th",{className:"px-6 py-3 text-left text-[10px] font-black text-white uppercase tracking-widest",children:"Client"}),t.jsx("th",{className:"px-6 py-3 text-left text-[10px] font-black text-white uppercase tracking-widest",children:"Date / Échéance"}),t.jsx("th",{className:"px-6 py-3 text-left text-[10px] font-black text-white uppercase tracking-widest",children:"Total"}),t.jsx("th",{className:"px-6 py-3 text-left text-[10px] font-black text-white uppercase tracking-widest",children:"Paiement"}),t.jsx("th",{className:"px-6 py-3 text-right text-[10px] font-black text-white uppercase tracking-widest",children:"Actions"})]})}),t.jsx("tbody",{className:"bg-white divide-y divide-gray-100 dark:bg-gray-800 dark:divide-gray-700",children:b.map(e=>t.jsxs("tr",{className:`${m.includes(e.id)?"bg-primary-50 dark:bg-primary-900/10":""} transition-colors`,children:[t.jsx("td",{className:"px-4 py-4 text-center",children:t.jsx("input",{type:"checkbox",className:"h-4 w-4 text-primary-600 rounded",checked:m.includes(e.id),onChange:()=>re(e.id)})}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white uppercase tracking-tighter",children:e.referenceNumber}),t.jsx("td",{className:"px-6 py-4 text-sm text-gray-600 dark:text-gray-300 font-medium uppercase tracking-tighter truncate max-w-[150px]",children:ae(e.customerId)}),t.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[t.jsx("div",{className:"text-xs font-bold",children:new Date(e.date).toLocaleDateString("fr-FR")}),t.jsx("div",{className:"mt-1",children:de(e)})]}),t.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[t.jsx("div",{className:"text-sm font-black",children:q(e.grandTotal)}),t.jsxs("div",{className:"text-[9px] font-bold text-red-500 uppercase",children:["Dû: ",q(e.grandTotal-e.paidAmount)]})]}),t.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:t.jsx("span",{className:`px-3 py-1 inline-flex text-[9px] font-black leading-5 rounded-full uppercase tracking-widest ${ie(e.paymentStatus)}`,children:e.paymentStatus})}),t.jsx("td",{className:"px-6 py-4 text-right",children:t.jsxs(Se,{children:[t.jsxs(N,{onClick:()=>S(`/sales/edit/${e.id}`),children:[t.jsx(xe,{className:"w-4 h-4 mr-3"})," Modifier"]}),t.jsxs(N,{onClick:()=>le(e),children:[t.jsx(ge,{className:"w-4 h-4 mr-3"})," Règlement"]}),t.jsxs(N,{onClick:()=>S(`/sales/invoice/${e.id}`),children:[t.jsx(ye,{className:"w-4 h-4 mr-3"})," Facture PDF"]}),t.jsxs(N,{onClick:()=>ce(e),className:"text-red-600 font-bold",children:[t.jsx(fe,{className:"w-4 h-4 mr-3"})," Supprimer"]})]})})]},e.id))})]})})}),t.jsx(Ne,{currentPage:p,totalPages:se,onPageChange:O,totalItems:w.length,itemsPerPage:f})]})]})};export{Ae as default};
