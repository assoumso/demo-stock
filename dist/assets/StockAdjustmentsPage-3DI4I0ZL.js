import{u as K,r,j as e,q as V,d as w,e as l,o as J,g as k,l as X,k as M}from"./index-szRe9_7c.js";import{P as Y}from"./Pagination-CsLxWpMj.js";const se=()=>{const{user:T}=K(),[x,R]=r.useState([]),[N,F]=r.useState([]),[g,O]=r.useState([]),[Q,I]=r.useState(!0),[P,q]=r.useState(!1),[C,c]=r.useState(null),[n,u]=r.useState({date:new Date().toISOString().split("T")[0],warehouseId:"",productId:"",type:"addition",quantity:1,reason:""}),[i,v]=r.useState(""),[y,W]=r.useState(1),b=15,A=async()=>{I(!0),c(null);try{const t=V(w(l,"stockAdjustments"),J("date","desc")),[s,d,m]=await Promise.all([k(t),k(w(l,"products")),k(w(l,"warehouses"))]);R(s.docs.map(a=>({id:a.id,...a.data()}))),F(d.docs.map(a=>({id:a.id,...a.data()})));const o=m.docs.map(a=>({id:a.id,...a.data()}));O(o),!n.warehouseId&&o.length>0&&u(a=>({...a,warehouseId:o[0].id}))}catch{c("Impossible de charger les données.")}finally{I(!1)}};r.useEffect(()=>{A()},[]);const f=t=>{const{name:s,value:d}=t.target,m=s==="quantity";u(o=>({...o,[s]:m?parseInt(d)||0:d}))},z=async t=>{t.preventDefault();const{warehouseId:s,productId:d,type:m,quantity:o,reason:a}=n;if(!s||!d||!o||!a){c("Veuillez remplir tous les champs.");return}q(!0),c(null);try{await X(l,async h=>{const D=M(l,"products",d),L=await h.get(D);if(!L.exists())throw new Error("Produit non trouvé.");const p=L.data().stockLevels||[],S=p.findIndex(H=>H.warehouseId===s),j=m==="addition"?o:-o;if(S>-1){if(p[S].quantity+j<0)throw new Error("Stock insuffisant pour cette soustraction.");p[S].quantity+=j}else{if(j<0)throw new Error("Stock insuffisant pour cette soustraction.");p.push({warehouseId:s,quantity:j})}h.update(D,{stockLevels:p});const G={...n,createdByUserId:T.uid,date:new Date().toISOString()};h.set(M(w(l,"stockAdjustments")),G)}),await A(),u({date:new Date().toISOString().split("T")[0],warehouseId:g.length>0?g[0].id:"",productId:"",type:"addition",quantity:1,reason:""}),v("")}catch(h){c(`Échec de l'ajustement: ${h.message}`)}finally{q(!1)}},B=t=>{var s;return((s=g.find(d=>d.id===t))==null?void 0:s.name)||"N/A"},U=t=>{var s;return((s=N.find(d=>d.id===t))==null?void 0:s.name)||"N/A"},_=r.useMemo(()=>x.slice((y-1)*b,y*b),[x,y]),$=Math.ceil(x.length/b),E=r.useMemo(()=>i?N.filter(t=>t.type!=="service"&&(t.name.toLowerCase().includes(i.toLowerCase())||t.sku.toLowerCase().includes(i.toLowerCase()))).slice(0,5):[],[i,N]);return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md h-fit",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Nouvel Ajustement"}),e.jsxs("form",{onSubmit:z,className:"space-y-4",children:[C&&e.jsx("div",{className:"p-3 my-2 text-sm text-red-700 bg-red-100 rounded-md",children:C}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Entrepôt"}),e.jsx("select",{name:"warehouseId",value:n.warehouseId,onChange:f,required:!0,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700",children:g.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm",children:"Produit"}),e.jsx("input",{type:"text",value:i,onChange:t=>{v(t.target.value),n.productId&&u(s=>({...s,productId:""}))},placeholder:"Rechercher par nom ou SKU",required:!n.productId,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700"}),i&&E.length>0&&!n.productId&&e.jsx("ul",{className:"absolute z-10 w-full bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-md mt-1 max-h-48 overflow-y-auto",children:E.map(t=>e.jsxs("li",{className:"p-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",onClick:()=>{u(s=>({...s,productId:t.id})),v(t.name)},children:[t.name," (",t.sku,")"]},t.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Type"}),e.jsxs("select",{name:"type",value:n.type,onChange:f,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700",children:[e.jsx("option",{value:"addition",children:"Addition"}),e.jsx("option",{value:"subtraction",children:"Soustraction"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Quantité"}),e.jsx("input",{type:"number",name:"quantity",min:"1",value:n.quantity,onChange:f,required:!0,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Motif"}),e.jsx("textarea",{name:"reason",value:n.reason,onChange:f,required:!0,rows:3,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700"})]}),e.jsx("button",{type:"submit",disabled:P,className:"w-full px-4 py-2 text-white bg-primary-600 rounded-md hover:bg-primary-700",children:P?"Enregistrement...":"Enregistrer"})]})]}),e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Historique des ajustements"}),Q?e.jsx("p",{children:"Chargement..."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow-md rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-primary-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Produit"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Type"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Qté"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Motif"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:_.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4",children:new Date(t.date).toLocaleDateString()}),e.jsxs("td",{className:"px-6 py-4 font-medium",children:[U(t.productId)," (",B(t.warehouseId),")"]}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${t.type==="addition"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:t.type==="addition"?"Addition":"Soustraction"})}),e.jsx("td",{className:"px-6 py-4",children:t.quantity}),e.jsx("td",{className:"px-6 py-4",children:t.reason})]},t.id))})]})}),e.jsx(Y,{currentPage:y,totalPages:$,onPageChange:W,totalItems:x.length,itemsPerPage:b})]})]})]})};export{se as default};
