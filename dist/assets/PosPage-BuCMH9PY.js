import{R as we,j as e,u as Ne,r as n,f as ve,h as ke,D as Se,g as C,i as Ce,d as N,e as h,k as J,q as Ie,w as Le,l as Re}from"./index-0SUTSTHz.js";import{M as le}from"./Modal-D7o8EM96.js";import{r as ce}from"./index-zh5gQrWE.js";const Pe=we.forwardRef(({sale:c,customer:f,products:E,companyInfo:g,warehouse:A},v)=>{const I=u=>new Intl.NumberFormat("fr-FR").format(u)+` ${g.currencySymbol||"FCFA"}`,k=u=>{var b;return((b=E.find(z=>z.id===u))==null?void 0:b.name)||"Produit inconnu"};return e.jsxs("div",{ref:v,className:"bg-white text-black p-4 font-mono text-xs",style:{width:"80mm"},children:[e.jsxs("div",{className:"text-center",children:[g.companyLogoUrl&&e.jsx("img",{src:g.companyLogoUrl,alt:"Logo",className:"mx-auto h-12 w-auto mb-2"}),e.jsx("h2",{className:"text-lg font-bold",children:g.companyName}),e.jsx("p",{children:g.companyAddress}),e.jsx("p",{children:g.companyPhone})]}),e.jsx("hr",{className:"my-2 border-dashed border-black"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Réf:"}),e.jsx("span",{children:c.referenceNumber})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Date:"}),e.jsx("span",{children:new Date(c.date).toLocaleString("fr-FR")})]}),A&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Entrepôt:"}),e.jsx("span",{children:A.name})]}),f&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Client:"}),e.jsx("span",{children:f.name})]}),e.jsx("hr",{className:"my-2 border-dashed border-black"}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left",children:"Article"}),e.jsx("th",{className:"text-center",children:"Qté"}),e.jsx("th",{className:"text-right",children:"Prix"}),e.jsx("th",{className:"text-right",children:"Total"})]})}),e.jsx("tbody",{children:c.items.map(u=>e.jsxs("tr",{children:[e.jsx("td",{className:"text-left",children:k(u.productId)}),e.jsx("td",{className:"text-center",children:u.quantity}),e.jsx("td",{className:"text-right",children:u.price.toLocaleString("fr-FR")}),e.jsx("td",{className:"text-right",children:u.subtotal.toLocaleString("fr-FR")})]},u.productId))})]}),e.jsx("hr",{className:"my-2 border-dashed border-black"}),e.jsxs("div",{className:"flex justify-between font-bold",children:[e.jsx("span",{children:"TOTAL:"}),e.jsx("span",{children:I(c.grandTotal)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Payé:"}),e.jsx("span",{children:I(c.paidAmount)})]}),c.paidAmount>=c.grandTotal&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Rendu:"}),e.jsx("span",{children:I(c.paidAmount-c.grandTotal)})]}),e.jsx("div",{className:"text-center mt-4",children:e.jsx("p",{children:g.invoiceFooterText||"Merci de votre visite !"})})]})}),Me=()=>{const{user:c}=Ne(),[f,E]=n.useState([]),[g,A]=n.useState([]),[v,I]=n.useState([]),[k,u]=n.useState([]),[b,z]=n.useState({}),[ie,K]=n.useState(!0),[X,S]=n.useState(null),[D,de]=n.useState(""),[L,Z]=n.useState("all"),[o,R]=n.useState([]),[y,Q]=n.useState(""),[x,_]=n.useState(""),[M,ee]=n.useState(0),[oe,P]=n.useState(!1),[j,Y]=n.useState(0),[Te,ue]=n.useState("Espèces"),[q,te]=n.useState(null),[xe,se]=n.useState(!1),ae=n.useRef(null);n.useEffect(()=>{c&&(async()=>{K(!0),S(null);try{const[s,r,a,l,p]=await Promise.all([C(N(h,"products")),C(N(h,"categories")),C(N(h,"customers")),C(N(h,"warehouses")),Ce(J(h,"settings","app-config"))]);E(s.docs.map(d=>({id:d.id,...d.data()}))),A(r.docs.map(d=>({id:d.id,...d.data()})));const U=a.docs.map(d=>({id:d.id,...d.data()}));I(U);const V=l.docs.map(d=>({id:d.id,...d.data()}));u(V);const i=p.exists()?p.data():{};z(i);const F=i.defaultPosCustomerId||"walkin";_(F)}catch(s){S("Impossible de charger les données du POS."),console.error(s)}finally{K(!1)}})()},[c]),n.useEffect(()=>{(async()=>{if(!x||x==="walkin"){ee(0);return}try{const s=Ie(N(h,"sales"),Le("customerId","==",x)),r=await C(s);let a=0;r.docs.forEach(l=>{const p=l.data();p.paymentStatus!=="Payé"&&(a+=p.grandTotal-(p.paidAmount||0))}),ee(a)}catch{console.warn("Erreur calcul solde client POS")}})()},[x]);const T=n.useMemo(()=>{if(!c)return[];const t=c.warehouseIds||[];return c.role.name.toLowerCase().includes("admin")?k:k.filter(s=>t.includes(s.id))},[c,k]);n.useEffect(()=>{if(T.length>0){const t=T.some(s=>s.id===y);(!y||!t)&&Q(T[0].id)}else Q("")},[T,y]);const $=t=>{var r,a;const s=f.find(l=>l.id===t);return(s==null?void 0:s.type)==="service"?1/0:((a=(r=s==null?void 0:s.stockLevels)==null?void 0:r.find(l=>l.warehouseId===y))==null?void 0:a.quantity)||0},me=n.useMemo(()=>f.filter(t=>{const s=t.name.toLowerCase().includes(D.toLowerCase())||t.sku.toLowerCase().includes(D.toLowerCase()),r=L==="all"||t.categoryId===L;return s&&r}),[f,D,L]),re=t=>{R(s=>s.filter(r=>r.productId!==t))},O=(t,s)=>{const r=$(t);s>r&&(s=r),s<=0?re(t):R(a=>a.map(l=>l.productId===t?{...l,quantity:s,subtotal:l.price*s}:l))},pe=(t,s)=>{R(r=>r.map(a=>{if(a.productId===t){const l=s>=0?s:0;return{...a,price:l,subtotal:l*a.quantity}}return a}))},he=t=>{const s=o.find(a=>a.productId===t.id),r=$(t.id);if(s)s.quantity<r&&O(t.id,s.quantity+1);else if(r>0){const a={productId:t.id,quantity:1,price:t.price,subtotal:t.price};R(l=>[...l,a])}},m=n.useMemo(()=>o.reduce((t,s)=>t+s.subtotal,0),[o]),ge=n.useMemo(()=>{const t=Number(j);return!isNaN(t)&&t>=m?t-m:0},[j,m]),fe=(ce.useReactToPrint||ce)({content:()=>ae.current}),ne=async()=>{R([]),P(!1),Y(0),ue("Espèces"),te(null),se(!1);try{const t=await C(N(h,"products"));E(t.docs.map(s=>({id:s.id,...s.data()})))}catch(t){console.error("Failed to refetch products after sale:",t),S("Impossible de mettre à jour les stocks.")}},be=async()=>{if(o.length===0||!y||!x||!c){S("Impossible de finaliser la vente. Données manquantes.");return}const t=v.find(r=>r.id===x);if(t!=null&&t.isCreditLimited){const r=M+(m-j);if(r>(t.creditLimit||0)&&!window.confirm(`ALERTE LIMITE DE CRÉDIT : Ce client (${t.name}) va dépasser sa limite (${W(t.creditLimit||0)}) pour atteindre un crédit de ${W(r)}. Souhaitez-vous continuer ?`))return}S(null);const s={referenceNumber:`${b.saleInvoicePrefix||"POS-"}${Date.now()}`,date:new Date().toISOString(),customerId:x,warehouseId:y,items:o,grandTotal:m,paidAmount:j,paymentStatus:j>=m?"Payé":j>0?"Partiel":"En attente",saleStatus:"Complétée"};try{const r=await Re(h,async a=>{const l=o.map(i=>J(h,"products",i.productId)),p=await Promise.all(l.map(i=>a.get(i))),U=[];for(let i=0;i<o.length;i++){const F=o[i],d=p[i];if(!d.exists())throw new Error(`Produit "${F.productId}" non trouvé.`);const G=d.data();if(G.type==="service")continue;const B=[...G.stockLevels||[]],H=B.findIndex(je=>je.warehouseId===y);if(H===-1||B[H].quantity<F.quantity)throw new Error(`Stock insuffisant pour ${G.name}.`);B[H].quantity-=F.quantity,U.push({ref:l[i],data:{stockLevels:B}})}for(const i of U)a.update(i.ref,i.data);const V=J(N(h,"sales"));return a.set(V,s),V});te({id:r.id,...s}),P(!1),se(!0)}catch(r){S(`Échec de la vente: ${r.message}`),P(!1)}},W=t=>new Intl.NumberFormat("fr-FR").format(t)+" FCFA";if(ie)return e.jsx("div",{children:"Chargement du Point de Vente..."});const w=v.find(t=>t.id===x),ye=(w==null?void 0:w.isCreditLimited)&&M+m>(w.creditLimit||0);return e.jsxs("div",{className:"flex h-[calc(100vh-64px)] overflow-hidden bg-gray-100 dark:bg-gray-900",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[e.jsxs("div",{className:"sticky top-0 bg-gray-100 dark:bg-gray-900 z-10 py-2 -mx-4 px-4",children:[ye&&e.jsxs("div",{className:"bg-red-500 text-white px-4 py-2 rounded-xl mb-4 text-xs font-bold uppercase tracking-widest flex items-center shadow-lg animate-pulse",children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"Alerte : Limite de crédit client atteinte ou dépassée"]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 mb-4",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx("input",{type:"text",placeholder:"Rechercher des produits...",value:D,onChange:t=>de(t.target.value),className:"w-full pl-10 pr-4 py-2 border rounded-full dark:bg-gray-800 dark:border-gray-700"}),e.jsx(ke,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"})]}),e.jsx("select",{value:y,onChange:t=>Q(t.target.value),className:"p-2 border rounded-md dark:bg-gray-800 dark:border-gray-700 font-bold",children:T.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>Z("all"),className:`px-3 py-1 text-sm font-bold rounded-full ${L==="all"?"bg-primary-600 text-white":"bg-white dark:bg-gray-700"}`,children:"Toutes"}),g.map(t=>e.jsx("button",{onClick:()=>Z(t.id),className:`px-3 py-1 text-sm font-bold rounded-full ${L===t.id?"bg-primary-600 text-white":"bg-white dark:bg-gray-700"}`,children:t.name},t.id))]})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mt-4",children:me.map(t=>{var l;const s=$(t.id),r=((l=o.find(p=>p.productId===t.id))==null?void 0:l.quantity)||0,a=s-r;return e.jsxs("div",{onClick:()=>(t.type==="service"||a>0)&&he(t),className:`relative border rounded-xl p-2 cursor-pointer text-center transition-all bg-white dark:bg-gray-800 ${t.type!=="service"&&a<=0?"opacity-50 cursor-not-allowed":"hover:shadow-2xl hover:-translate-y-1 hover:border-primary-500"}`,children:[t.imageUrl?e.jsx("img",{src:t.imageUrl,alt:t.name,className:"h-24 w-full object-cover rounded-lg"}):e.jsx("div",{className:"h-24 w-full bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center justify-center text-gray-400 text-[10px] font-black uppercase",children:"Article"}),e.jsx("p",{className:"text-[11px] font-black mt-2 h-8 overflow-hidden uppercase tracking-tighter text-gray-700 dark:text-gray-300",children:t.name}),e.jsxs("p",{className:"text-sm font-black text-primary-600",children:[t.price.toLocaleString("fr-FR")," ",e.jsx("span",{className:"text-[10px]",children:b.currencySymbol||"FCFA"})]}),t.type==="service"?e.jsx("span",{className:"absolute top-1 right-1 text-[9px] font-black uppercase px-2 py-0.5 rounded-full text-white bg-blue-500",children:"Svc"}):e.jsx("span",{className:`absolute top-1 right-1 text-[9px] font-black uppercase px-2 py-0.5 rounded-full text-white ${a>(t.minStockAlert||5)?"bg-green-500":a>0?"bg-yellow-500":"bg-red-500"}`,children:s})]},t.id)})})]}),e.jsxs("div",{className:"w-96 bg-white dark:bg-gray-800 border-l dark:border-gray-700 flex flex-col p-4 shadow-2xl",children:[e.jsx("h2",{className:"text-lg font-black uppercase tracking-widest text-gray-500 mb-4",children:"Commande"}),e.jsxs("div",{className:"flex flex-col gap-2 mb-4",children:[e.jsxs("select",{value:x,onChange:t=>_(t.target.value),className:"w-full p-3 border rounded-xl dark:bg-gray-700 dark:border-gray-600 font-bold outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"walkin",children:"Client de passage"}),v.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),w&&x!=="walkin"&&e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900/40 p-3 rounded-xl border border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"flex justify-between text-[10px] font-black uppercase text-gray-400",children:[e.jsx("span",{children:"Crédit Actuel"}),e.jsx("span",{className:M>0?"text-red-500":"",children:W(M)})]}),w.isCreditLimited&&e.jsxs("div",{className:"flex justify-between text-[10px] font-black uppercase text-orange-500 mt-1",children:[e.jsx("span",{children:"Limite Max"}),e.jsx("span",{children:W(w.creditLimit||0)})]})]})]}),e.jsx("div",{className:"flex-grow overflow-y-auto -mx-4 px-4 divide-y divide-gray-200 dark:divide-gray-700",children:o.length===0?e.jsx("div",{className:"text-center py-12 opacity-30",children:e.jsx("p",{className:"text-sm font-black uppercase tracking-widest",children:"Panier Vide"})}):o.map(t=>{const s=f.find(a=>a.id===t.productId);if(!s)return null;const r=$(s.id);return e.jsxs("div",{className:"flex items-center gap-2 py-4",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsx("p",{className:"text-xs font-black uppercase truncate text-gray-800 dark:text-gray-200",title:s.name,children:s.name}),e.jsx("div",{className:"flex items-center mt-1",children:e.jsx("input",{type:"number",value:t.price,onChange:a=>pe(t.productId,parseFloat(a.target.value)||0),className:"w-20 text-[11px] p-1 border rounded bg-gray-50 dark:bg-gray-700 font-bold"})})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>O(t.productId,t.quantity-1),className:"w-7 h-7 rounded-full bg-gray-100 dark:bg-gray-700 font-black",children:"-"}),e.jsx("input",{type:"number",value:t.quantity,onChange:a=>O(t.productId,parseInt(a.target.value)||0),className:"w-10 text-center bg-transparent font-black text-sm"}),e.jsx("button",{onClick:()=>O(t.productId,t.quantity+1),disabled:t.quantity>=r,className:"w-7 h-7 rounded-full bg-gray-100 dark:bg-gray-700 font-black disabled:opacity-30",children:"+"})]}),e.jsx("div",{className:"w-20 text-right",children:e.jsx("p",{className:"font-black text-sm",children:t.subtotal.toLocaleString("fr-FR")})}),e.jsx("button",{onClick:()=>re(t.productId),className:"text-gray-300 hover:text-red-500 transition-colors",children:e.jsx(Se,{className:"w-4 h-4"})})]},t.productId)})}),e.jsxs("div",{className:"pt-6 border-t dark:border-gray-700 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-baseline",children:[e.jsx("span",{className:"text-xs font-black uppercase text-gray-400",children:"Total à payer"}),e.jsxs("span",{className:"text-3xl font-black text-primary-600",children:[m.toLocaleString("fr-FR")," ",e.jsx("span",{className:"text-sm",children:b.currencySymbol})]})]}),e.jsx("button",{onClick:()=>{P(!0),Y(m)},disabled:o.length===0,className:"w-full py-4 bg-primary-600 text-white rounded-2xl font-black text-lg shadow-xl hover:bg-primary-700 transition-all active:scale-95 disabled:opacity-50",children:"PAYER MAINTENANT"})]})]}),e.jsx(le,{isOpen:oe,onClose:()=>P(!1),title:"Paiement & Finalisation",children:e.jsxs("div",{className:"p-6",children:[X&&e.jsx("p",{className:"text-red-500 bg-red-100 p-3 rounded-xl mb-6 font-bold text-center text-sm",children:X}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("p",{className:"text-xs font-black uppercase text-gray-400 tracking-widest mb-1",children:"Montant de la commande"}),e.jsxs("p",{className:"text-5xl font-black text-gray-900 dark:text-white tracking-tighter",children:[m.toLocaleString("fr-FR")," ",e.jsx("span",{className:"text-lg",children:b.currencySymbol})]})]}),e.jsxs("div",{className:"space-y-4 mb-8",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400 mb-1",children:"Somme reçue"}),e.jsx("input",{type:"number",value:j,onChange:t=>Y(Number(t.target.value)),className:"w-full p-4 border rounded-2xl dark:bg-gray-700 text-2xl font-black outline-none focus:ring-4 focus:ring-primary-500/20"})]}),e.jsxs("div",{className:"flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-900/30 rounded-2xl border border-gray-100 dark:border-gray-700",children:[e.jsx("span",{className:"text-xs font-black uppercase text-gray-500",children:"Monnaie à rendre"}),e.jsx("span",{className:"text-xl font-black text-green-600",children:ge.toLocaleString("fr-FR")})]})]}),e.jsx("button",{onClick:be,className:"w-full py-5 bg-green-600 text-white rounded-2xl font-black text-xl shadow-2xl hover:bg-green-700 transition-all active:scale-95",children:"CONFIRMER LA VENTE"})]})}),e.jsx(le,{isOpen:xe,onClose:async()=>{await ne()},title:"Impression du Reçu",children:e.jsxs("div",{className:"p-4",children:[q&&e.jsx(Pe,{ref:ae,sale:q,customer:v.find(t=>t.id===q.customerId)||null,products:f,companyInfo:b,warehouse:k.find(t=>t.id===q.warehouseId)||null}),e.jsxs("div",{className:"mt-8 flex gap-3",children:[e.jsx("button",{onClick:async()=>{await ne()},className:"flex-1 py-3 bg-gray-100 dark:bg-gray-700 rounded-xl font-black text-xs uppercase tracking-widest",children:"Suivant"}),e.jsx("button",{onClick:fe,className:"flex-1 py-3 bg-primary-600 text-white rounded-xl font-black text-xs uppercase tracking-widest shadow-lg",children:"Imprimer"})]})]})})]})};export{Me as default};
