import{t as ye,b as je,u as ke,r as o,j as e,f as we,P as Ne,D as ve,g as V,i as ne,d as C,e as p,k as E,q as Ce,w as Se,l as Ie,y as De}from"./index-szRe9_7c.js";import{M as Le}from"./Modal-BWnk_ifJ.js";const Pe=()=>{const{id:f}=ye(),z=je(),{user:q}=ke(),b=!!f,[U,G]=o.useState([]),[B,le]=o.useState([]),[P,oe]=o.useState([]),[r,d]=o.useState({referenceNumber:"",date:new Date().toISOString().split("T")[0],customerId:"",warehouseId:"",items:[],grandTotal:0,paidAmount:0,paymentStatus:"En attente",saleStatus:"En attente",paymentDeadlineDays:0}),[ie,J]=o.useState(!0),[K,x]=o.useState(null),[S,_]=o.useState(""),[ce,A]=o.useState(!1),[y,T]=o.useState({name:"",email:"",phone:""}),[H,X]=o.useState(!1),[$,I]=o.useState(""),[O,Y]=o.useState(0),[u,F]=o.useState(null);o.useEffect(()=>{(async()=>{J(!0);try{const[s,a,n,l]=await Promise.all([V(C(p,"customers")),V(C(p,"warehouses")),V(C(p,"products")),ne(E(p,"settings","app-config"))]),c=s.docs.map(i=>({id:i.id,...i.data()}));G(c);const w=a.docs.map(i=>({id:i.id,...i.data()}));le(w),oe(n.docs.map(i=>({id:i.id,...i.data()})));const N=l.exists()?l.data():null,M=(N==null?void 0:N.saleInvoicePrefix)||"VNT-";if(b){const i=await ne(E(p,"sales",f));if(i.exists()){const j=i.data();d(j);const m=c.find(L=>L.id===j.customerId);m&&(I(m.name),F(m))}else x("Vente non trouvée.")}else d(i=>({...i,referenceNumber:`${M}${Date.now()}`,customerId:""})),I("")}catch(s){x("Erreur de chargement des données."),console.error(s)}finally{J(!1)}})()},[f,b]),o.useEffect(()=>{(async()=>{if(!r.customerId){Y(0);return}try{const s=Ce(C(p,"sales"),Se("customerId","==",r.customerId)),a=await V(s);let n=0;a.docs.forEach(l=>{const c=l.data();f&&l.id===f||c.paymentStatus!=="Payé"&&(n+=c.grandTotal-(c.paidAmount||0))}),Y(n)}catch{console.warn("Erreur calcul solde client")}})()},[r.customerId,f]);const D=o.useMemo(()=>{if(!q)return[];if(q.role.name.toLowerCase().includes("admin"))return B;const t=q.warehouseIds||[];return B.filter(s=>t.includes(s.id))},[q,B]);o.useEffect(()=>{if(D.length>0){const t=D.some(s=>s.id===r.warehouseId);(!r.warehouseId||!t)&&d(s=>({...s,warehouseId:D[0].id}))}else d(t=>({...t,warehouseId:""}))},[D,r.warehouseId]);const de=t=>t.reduce((s,a)=>s+a.subtotal,0);o.useEffect(()=>{const t=de(r.items);let s="En attente";r.paidAmount>=t&&t>0?s="Payé":r.paidAmount>0&&(s="Partiel"),d(a=>({...a,grandTotal:t,paymentStatus:s}))},[r.items,r.paidAmount]);const k=t=>{const{name:s,value:a}=t.target,n=["paidAmount","paymentDeadlineDays"].includes(s);d(l=>({...l,[s]:n?parseFloat(a)||0:a}))},Z=(t,s,a)=>{const n=[...r.items],l=n[t];l[s]=a,l.subtotal=l.quantity*l.price,d(c=>({...c,items:n}))},W=(t,s)=>{const a=P.find(l=>l.id===t);if((a==null?void 0:a.type)==="service")return 1/0;if(!a||!a.stockLevels)return 0;const n=a.stockLevels.find(l=>l.warehouseId===s);return n?n.quantity:0},ue=t=>t.type==="service"?1/0:!t||!t.stockLevels?0:t.stockLevels.reduce((s,a)=>s+a.quantity,0),me=t=>{if(!r.items.some(s=>s.productId===t.id)){const s={productId:t.id,quantity:1,price:t.price||0,subtotal:t.price||0};d(a=>({...a,items:[...a.items,s]}))}_("")},pe=t=>{d(s=>({...s,items:s.items.filter((a,n)=>n!==t)}))},xe=async t=>{if(t.preventDefault(),x(null),r.items.length===0){x("Veuillez ajouter au moins un produit.");return}if(!r.customerId){x("Veuillez sélectionner un client.");return}if(u!=null&&u.isCreditLimited){const a=r.grandTotal-r.paidAmount,n=O+a;if(n>(u.creditLimit||0)&&!window.confirm(`ALERTE LIMITE DE CRÉDIT : Le solde total du client (${g(n)}) va dépasser sa limite autorisée (${g(u.creditLimit||0)}). Voulez-vous quand même forcer cette vente ?`))return}for(const a of r.items){const n=W(a.productId,r.warehouseId);if(a.quantity>n){x(`Stock insuffisant pour le produit "${se(a.productId)}". Quantité demandée : ${a.quantity}, disponible : ${n}.`);return}}const s={...r};if(r.paymentDeadlineDays&&r.paymentDeadlineDays>0){const a=new Date(r.date);a.setDate(a.getDate()+Number(r.paymentDeadlineDays)),s.paymentDueDate=a.toISOString()}else s.paymentDueDate=null;try{await Ie(p,async a=>{const n=b?E(p,"sales",f):E(C(p,"sales")),l=b?await a.get(n):null,c=l!=null&&l.exists()?l.data():null;for(const w of s.items){const N=E(p,"products",w.productId),M=await a.get(N);if(!M.exists())continue;const i=M.data();if(i.type==="service")continue;const j=[...i.stockLevels||[]];let m=0;const L=(c==null?void 0:c.saleStatus)==="Complétée",Q=s.saleStatus==="Complétée",v=c==null?void 0:c.items.find(R=>R.productId===w.productId);if(!L&&Q?m=-w.quantity:L&&!Q?m=(v==null?void 0:v.quantity)||0:L&&Q&&(m=((v==null?void 0:v.quantity)||0)-w.quantity),m!==0){const R=j.findIndex(be=>be.warehouseId===s.warehouseId);R>-1?j[R].quantity+=m:m<0&&j.push({warehouseId:s.warehouseId,quantity:m}),a.update(N,{stockLevels:j})}}b?a.update(n,s):a.set(n,s)}),z("/sales")}catch(a){x(`Erreur de sauvegarde: ${a.message}`)}},ee=o.useMemo(()=>S?P.filter(t=>t.name.toLowerCase().includes(S.toLowerCase())||t.sku.toLowerCase().includes(S.toLowerCase())).slice(0,5):[],[S,P]),te=o.useMemo(()=>$?U.filter(t=>t.name.toLowerCase().includes($.toLowerCase())).slice(0,5):[],[$,U]),he=async t=>{if(t.preventDefault(),!!y.name){X(!0);try{const s={name:y.name||"",phone:y.phone||"",email:y.email||"",isCreditLimited:!1,creditLimit:0},n={id:(await De(C(p,"customers"),s)).id,...s};G(l=>[...l,n]),d(l=>({...l,customerId:n.id})),I(n.name),F(n),A(!1),T({name:"",phone:"",email:""})}catch{x("Erreur lors de la création du client.")}finally{X(!1)}}},se=t=>{var s;return((s=P.find(a=>a.id===t))==null?void 0:s.name)||"Produit inconnu"};if(ie)return e.jsx("div",{className:"text-center p-8",children:"Chargement du formulaire..."});const h="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white transition-all focus:ring-primary-500 focus:border-primary-500",ae="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white",g=t=>new Intl.NumberFormat("fr-FR").format(t||0)+" Fcfa",ge=r.grandTotal-r.paidAmount,re=O+ge,fe=(u==null?void 0:u.isCreditLimited)&&re>(u.creditLimit||0);return e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md",children:[e.jsxs("form",{onSubmit:xe,className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 dark:text-white uppercase tracking-tight",children:b?"Modifier la Vente":"Créer une Vente"}),e.jsx("button",{type:"button",onClick:()=>z("/sales"),className:"text-sm text-gray-500 font-bold hover:text-gray-900 dark:hover:white uppercase",children:"← Retour"})]}),K&&e.jsx("div",{className:"p-3 my-2 text-sm text-red-700 bg-red-100 rounded-md dark:bg-red-900/40 dark:text-red-300 font-bold text-center border border-red-200",children:K}),fe&&e.jsxs("div",{className:"bg-red-600 text-white p-4 rounded-xl shadow-xl flex items-center animate-pulse",children:[e.jsx("div",{className:"bg-white/20 p-2 rounded-lg mr-4",children:e.jsx(we,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-black text-sm uppercase",children:"Dépassement de Limite de Crédit"}),e.jsxs("p",{className:"text-xs opacity-90",children:["Ce client a un solde actuel de ",e.jsx("span",{className:"font-black",children:g(O)}),". Avec cette vente, son crédit passera à ",e.jsx("span",{className:"font-black underline",children:g(re)})," alors que son plafond est de ",e.jsx("span",{className:"font-black",children:g((u==null?void 0:u.creditLimit)||0)}),"."]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Date"}),e.jsx("input",{type:"date",name:"date",value:r.date,onChange:k,required:!0,className:h})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Réf. Vente"}),e.jsx("input",{type:"text",name:"referenceNumber",value:r.referenceNumber,onChange:k,required:!0,className:h})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Client"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"text",value:$,onChange:t=>{I(t.target.value),d(s=>({...s,customerId:""})),F(null)},placeholder:"Rechercher un client",className:`${h} rounded-r-none`}),e.jsx("button",{type:"button",onClick:()=>A(!0),className:"px-3 py-2 bg-primary-600 text-white rounded-r-md hover:bg-primary-700 h-10 mt-1",children:e.jsx(Ne,{className:"w-5 h-5"})})]}),te.length>0&&!r.customerId&&e.jsx("ul",{className:"absolute z-20 w-full mt-1 bg-white dark:bg-gray-800 shadow-2xl rounded-md py-1 border dark:border-gray-700 overflow-hidden",children:te.map(t=>e.jsxs("li",{onClick:()=>{d(s=>({...s,customerId:t.id})),I(t.name),F(t)},className:"cursor-pointer px-4 py-3 hover:bg-primary-50 dark:hover:bg-primary-900/30 text-sm font-medium border-b last:border-0 dark:border-gray-700",children:[t.name," ",t.isCreditLimited&&e.jsxs("span",{className:"text-[10px] ml-2 text-orange-600 font-bold",children:["(Limite: ",g(t.creditLimit),")"]})]},t.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Entrepôt"}),e.jsx("select",{name:"warehouseId",value:r.warehouseId,onChange:k,required:!0,className:ae,children:D.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-orange-500",children:"Délai Paiement (Jours)"}),e.jsx("input",{type:"number",name:"paymentDeadlineDays",min:"0",placeholder:"Ex: 7",value:r.paymentDeadlineDays||"",onChange:k,className:`${h} border-orange-200 dark:border-orange-900/30`})]})]}),e.jsxs("div",{className:"border-t pt-4 dark:border-gray-700 relative",children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400 mb-1",children:"Ajouter des produits"}),e.jsx("input",{type:"text",value:S,onChange:t=>_(t.target.value),placeholder:"Scanner ou taper le nom / SKU...",className:h}),ee.length>0&&e.jsx("ul",{className:"absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 shadow-2xl max-h-60 rounded-md py-1 border dark:border-gray-700 overflow-auto",children:ee.map(t=>{const s=W(t.id,r.warehouseId),a=ue(t);return e.jsxs("li",{onClick:()=>me(t),className:"cursor-pointer px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 flex justify-between items-center border-b last:border-0 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-sm",children:t.name}),e.jsx("p",{className:"text-[10px] text-gray-400 uppercase font-black",children:t.sku})]}),t.type==="service"?e.jsx("span",{className:"text-[10px] font-black uppercase bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full",children:"Service"}):e.jsxs("div",{className:"text-right",children:[e.jsxs("span",{className:`text-[10px] font-black uppercase ${s>0?"bg-green-100 text-green-800":"bg-red-100 text-red-800"} px-2 py-0.5 rounded-full`,children:["Dispo: ",s]}),e.jsxs("p",{className:"text-[10px] text-gray-400 mt-1",children:["Total: ",a]})]})]},t.id)})})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-[10px] font-black uppercase text-gray-500 w-2/5 tracking-widest",children:"Produit"}),e.jsx("th",{className:"px-4 py-3 text-left text-[10px] font-black uppercase text-gray-500 tracking-widest",children:"Prix"}),e.jsx("th",{className:"px-4 py-3 text-left text-[10px] font-black uppercase text-gray-500 tracking-widest",children:"Quantité"}),e.jsx("th",{className:"px-4 py-3 text-left text-[10px] font-black uppercase text-gray-500 tracking-widest",children:"Sous-total"}),e.jsx("th",{})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:[r.items.map((t,s)=>{const a=W(t.productId,r.warehouseId),n=t.quantity>a;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 text-sm font-bold text-gray-800 dark:text-gray-200",children:se(t.productId)}),e.jsx("td",{className:"py-2",children:e.jsx("input",{type:"number",step:"any",value:t.price,onChange:l=>Z(s,"price",parseFloat(l.target.value)),className:`w-32 ${h}`})}),e.jsxs("td",{className:"py-2",children:[e.jsx("input",{type:"number",value:t.quantity,onChange:l=>Z(s,"quantity",parseInt(l.target.value)),className:`w-24 ${h} ${n?"border-red-500 focus:ring-red-500 focus:border-red-500 ring-2 ring-red-100":""}`}),n&&e.jsxs("p",{className:"text-red-500 text-[10px] font-bold mt-1 uppercase tracking-tighter",children:["Stock insuffisant (Dispo: ",a,")"]})]}),e.jsx("td",{className:"px-4 py-3 text-sm font-black text-gray-900 dark:text-white",children:g(t.subtotal)}),e.jsx("td",{className:"px-4 text-right",children:e.jsx("button",{type:"button",onClick:()=>pe(s),className:"text-gray-300 hover:text-red-600 transition-colors",children:e.jsx(ve,{className:"w-5 h-5"})})})]},s)}),r.items.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"py-8 text-center text-gray-400 italic text-sm",children:"Aucun produit ajouté."})})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 pt-6 border-t-2 border-dashed dark:border-gray-700",children:[e.jsxs("div",{className:"md:col-span-2 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Statut de la vente"}),e.jsxs("select",{name:"saleStatus",value:r.saleStatus,onChange:k,className:ae,children:[e.jsx("option",{children:"En attente"}),e.jsx("option",{children:"Complétée"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-green-600",children:"Montant payé (Encaissé)"}),e.jsx("input",{type:"number",name:"paidAmount",placeholder:"0",value:r.paidAmount||"",onChange:k,className:`${h} border-green-200 dark:border-green-900/30 text-green-700 font-bold`})]})]}),e.jsxs("div",{className:"space-y-4 bg-gray-50 dark:bg-gray-900/30 p-4 rounded-2xl border border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] font-black uppercase text-gray-400 mb-1",children:"Statut Paiement"}),e.jsx("span",{className:`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest ${r.paymentStatus==="Payé"?"bg-green-100 text-green-800":"bg-orange-100 text-orange-800"}`,children:r.paymentStatus})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx("h3",{className:"text-xs font-black text-gray-500 uppercase tracking-widest",children:"Total Général"}),e.jsx("p",{className:"text-3xl font-black text-primary-600 dark:text-primary-400 mt-1",children:g(r.grandTotal)})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-6",children:[e.jsx("button",{type:"button",onClick:()=>z("/sales"),className:"px-6 py-3 text-sm font-bold text-gray-500 bg-gray-100 rounded-xl hover:bg-gray-200 transition-all uppercase tracking-widest",children:"Annuler"}),e.jsx("button",{type:"submit",className:"px-10 py-3 text-sm text-white bg-primary-600 rounded-xl font-black shadow-lg hover:bg-primary-700 active:scale-95 transition-all uppercase tracking-widest",children:b?"Mettre à jour":"Enregistrer la vente"})]})]}),e.jsx(Le,{isOpen:ce,onClose:()=>A(!1),title:"Nouveau Client",children:e.jsxs("form",{onSubmit:he,className:"p-6 space-y-4",children:[e.jsx("input",{type:"text",placeholder:"Nom Complet",value:y.name||"",onChange:t=>T(s=>({...s,name:t.target.value})),required:!0,className:"w-full border rounded-xl p-3 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary-500 transition-all"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("input",{type:"tel",placeholder:"Téléphone",value:y.phone||"",onChange:t=>T(s=>({...s,phone:t.target.value})),className:"w-full border rounded-xl p-3 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary-500 transition-all"}),e.jsx("input",{type:"email",placeholder:"Email",value:y.email||"",onChange:t=>T(s=>({...s,email:t.target.value})),className:"w-full border rounded-xl p-3 dark:bg-gray-700 outline-none focus:ring-2 focus:ring-primary-500 transition-all"})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>A(!1),className:"px-4 py-2 bg-gray-100 rounded-lg font-bold text-sm uppercase",children:"Fermer"}),e.jsx("button",{type:"submit",disabled:H,className:"bg-primary-600 text-white px-6 py-2 rounded-lg font-black text-sm uppercase shadow-lg hover:bg-primary-700 transition-all",children:H?"Traitement...":"Ajouter Client"})]})]})})]})};export{Pe as default};
