import{t as me,b as xe,r as c,j as e,P as he,D as ge,g as z,i as te,d as I,e as u,k as v,l as be,y as ye}from"./index-0SUTSTHz.js";import{M as fe}from"./Modal-D7o8EM96.js";const ve=()=>{const{id:E}=me(),q=xe(),h=!!E,[O,U]=c.useState([]),[se,ae]=c.useState([]),[F,re]=c.useState([]),[r,p]=c.useState({referenceNumber:"",date:new Date().toISOString().split("T")[0],supplierId:"",warehouseId:"",items:[],shippingCost:0,grandTotal:0,paidAmount:0,paymentStatus:"En attente",purchaseStatus:"En attente",notes:""}),[ne,H]=c.useState(!0),[V,A]=c.useState(!1),[K,g]=c.useState(null),[w,Q]=c.useState(""),[le,P]=c.useState(!1),[i,y]=c.useState({name:"",contactPerson:"",phone:"",email:"",address:""}),[_,B]=c.useState(!1),[D,N]=c.useState("");c.useEffect(()=>{(async()=>{H(!0);try{const[s,n,l,a]=await Promise.all([z(I(u,"suppliers")),z(I(u,"warehouses")),z(I(u,"products")),te(v(u,"settings","app-config"))]),b=s.docs.map(o=>({id:o.id,...o.data()}));U(b);const S=n.docs.map(o=>({id:o.id,...o.data()}));ae(S),re(l.docs.map(o=>({id:o.id,...o.data()})));const j=a.exists()?a.data():null,T=(j==null?void 0:j.purchaseInvoicePrefix)||"ACH-";if(h){const o=await te(v(u,"purchases",E));if(o.exists()){const d=o.data();p(d);const L=b.find(R=>R.id===d.supplierId);L&&N(L.name)}else g("Achat non trouvé.")}else p(o=>({...o,referenceNumber:`${T}${Date.now()}`,supplierId:"",warehouseId:S.length>0?S[0].id:"",purchaseStatus:"Reçu"})),N("")}catch(s){g("Erreur de chargement des données."),console.error(s)}finally{H(!1)}})()},[E,h]);const oe=(t,s)=>t.reduce((l,a)=>l+a.subtotal,0)+s;c.useEffect(()=>{const t=oe(r.items,r.shippingCost||0);p(s=>({...s,grandTotal:t}))},[r.items,r.shippingCost]);const f=t=>{const{name:s,value:n}=t.target,l=["shippingCost"].includes(s);p(a=>({...a,[s]:l?parseFloat(n)||0:n}))},G=(t,s,n)=>{const l=[...r.items],a=l[t];a[s]=Number(n),a.subtotal=a.quantity*a.cost,p(b=>({...b,items:l}))},ce=t=>{if(!r.items.some(s=>s.productId===t.id)){const s={productId:t.id,quantity:1,cost:t.cost||0,subtotal:t.cost||0};p(n=>({...n,items:[...n.items,s]}))}Q("")},de=t=>{p(s=>({...s,items:s.items.filter((n,l)=>l!==t)}))},ie=async t=>{if(t.preventDefault(),g(null),A(!0),r.items.length===0){g("Veuillez ajouter au moins un produit."),A(!1);return}if(!r.supplierId){g("Veuillez sélectionner un fournisseur."),A(!1);return}try{await be(u,async s=>{const n=h?v(u,"purchases",E):v(I(u,"purchases")),l=h?await s.get(n):null,a=l!=null&&l.exists()?l.data():null,b=Array.from(new Set([...r.items.map(d=>d.productId),...(a==null?void 0:a.items.map(d=>d.productId))||[]])),S=await Promise.all(b.map(d=>s.get(v(u,"products",d)))),j=(a==null?void 0:a.purchaseStatus)==="Reçu",T=r.purchaseStatus==="Reçu",o=[];(j||T)&&b.forEach((d,L)=>{const R=S[L];if(!R.exists())return;const Z=R.data();if(Z.type==="service")return;let k=[...Z.stockLevels||[]];const $=r.items.find(x=>x.productId===d),ee=a==null?void 0:a.items.find(x=>x.productId===d);if(j&&ee){const x=a.warehouseId,C=k.findIndex(W=>W.warehouseId===x);C>-1&&(k[C].quantity-=ee.quantity)}if(T&&$){const x=r.warehouseId,C=k.findIndex(W=>W.warehouseId===x);C>-1?k[C].quantity+=$.quantity:k.push({warehouseId:x,quantity:$.quantity})}o.push({ref:v(u,"products",d),newStockLevels:k})}),o.forEach(d=>{s.update(d.ref,{stockLevels:d.newStockLevels})}),h?s.update(n,r):s.set(n,r)}),q("/purchases")}catch(s){g(`Erreur lors de l'enregistrement : ${s.message}`),console.error(s)}finally{A(!1)}},J=c.useMemo(()=>w?F.filter(t=>t.name.toLowerCase().includes(w.toLowerCase())||t.sku.toLowerCase().includes(w.toLowerCase())).slice(0,5):[],[w,F]),X=c.useMemo(()=>D?O.filter(t=>t.name.toLowerCase().includes(D.toLowerCase())).slice(0,5):[],[D,O]),ue=async t=>{if(t.preventDefault(),!!i.name){B(!0);try{const s={name:i.name||"",contactPerson:i.contactPerson||"",phone:i.phone||"",email:i.email||"",address:i.address||""},l={id:(await ye(I(u,"suppliers"),s)).id,...s};U(a=>[...a,l]),p(a=>({...a,supplierId:l.id})),N(l.name),P(!1),y({name:"",contactPerson:"",phone:"",email:"",address:""})}catch{g("Erreur lors de la création du fournisseur.")}finally{B(!1)}}},pe=t=>{var s;return((s=F.find(n=>n.id===t))==null?void 0:s.name)||"Produit inconnu"};if(ne)return e.jsx("div",{className:"text-center p-8",children:"Chargement du formulaire..."});const m="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-primary-500 focus:border-primary-500 outline-none",Y="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white",M=t=>new Intl.NumberFormat("fr-FR").format(t||0)+" Fcfa";return e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md",children:[e.jsxs("form",{onSubmit:ie,className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 dark:text-white uppercase tracking-tight",children:h?"Modifier l'Achat":"Créer un Achat"}),e.jsx("button",{type:"button",onClick:()=>q("/purchases"),className:"text-sm text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white font-bold",children:"← Retour"})]}),K&&e.jsx("div",{className:"p-3 my-2 text-sm text-red-700 bg-red-100 rounded-md dark:bg-red-900/40 dark:text-red-300 border border-red-200 font-bold text-center",children:K}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Date"}),e.jsx("input",{type:"date",name:"date",value:r.date,onChange:f,required:!0,className:m})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Réf. Achat"}),e.jsx("input",{type:"text",name:"referenceNumber",value:r.referenceNumber,onChange:f,required:!0,className:m})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Fournisseur"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"text",value:D,onChange:t=>{N(t.target.value),p(s=>({...s,supplierId:""}))},placeholder:"Rechercher un fournisseur",className:`${m} rounded-r-none`}),e.jsx("button",{type:"button",onClick:()=>P(!0),className:"px-3 py-2 bg-primary-600 text-white rounded-r-md hover:bg-primary-700 h-10 mt-1",children:e.jsx(he,{className:"w-5 h-5"})})]}),X.length>0&&!r.supplierId&&e.jsx("ul",{className:"absolute z-20 w-full mt-1 bg-white dark:bg-gray-800 shadow-2xl rounded-md py-1 border dark:border-gray-700",children:X.map(t=>e.jsx("li",{onClick:()=>{p(s=>({...s,supplierId:t.id})),N(t.name)},className:"cursor-pointer px-3 py-2 hover:bg-primary-50 dark:hover:bg-primary-900/40 text-sm font-bold border-b last:border-0",children:t.name},t.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Entrepôt de réception"}),e.jsx("select",{name:"warehouseId",value:r.warehouseId,onChange:f,required:!0,className:Y,children:se.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"border-t pt-4 dark:border-gray-700 relative",children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400 mb-1",children:"Ajouter des articles"}),e.jsx("input",{type:"text",value:w,onChange:t=>Q(t.target.value),placeholder:"Taper le nom ou SKU du produit...",className:m}),J.length>0&&e.jsx("ul",{className:"absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 shadow-2xl max-h-60 rounded-md py-1 border dark:border-gray-700 overflow-auto",children:J.map(t=>e.jsxs("li",{onClick:()=>ce(t),className:"cursor-pointer px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 flex justify-between items-center border-b last:border-0",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-sm",children:t.name}),e.jsx("p",{className:"text-[10px] text-gray-400 font-black",children:t.sku})]}),e.jsxs("span",{className:"text-[10px] font-black uppercase bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded",children:["HT: ",M(t.cost)]})]},t.id))})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-[10px] font-black uppercase text-gray-500 w-2/5 tracking-widest",children:"Désignation"}),e.jsx("th",{className:"px-4 py-2 text-left text-[10px] font-black uppercase text-gray-500 tracking-widest",children:"Coût Unitaire"}),e.jsx("th",{className:"px-4 py-2 text-left text-[10px] font-black uppercase text-gray-500 tracking-widest",children:"Quantité"}),e.jsx("th",{className:"px-4 py-2 text-left text-[10px] font-black uppercase text-gray-500 tracking-widest",children:"Sous-total"}),e.jsx("th",{})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:[r.items.map((t,s)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 text-sm font-bold text-gray-800 dark:text-gray-200",children:pe(t.productId)}),e.jsx("td",{children:e.jsx("input",{type:"number",step:"any",value:t.cost,onChange:n=>G(s,"cost",parseFloat(n.target.value)),className:`w-32 ${m}`})}),e.jsx("td",{children:e.jsx("input",{type:"number",value:t.quantity,onChange:n=>G(s,"quantity",parseInt(n.target.value)),className:`w-24 ${m}`})}),e.jsx("td",{className:"px-4 py-2 text-sm font-black",children:M(t.subtotal)}),e.jsx("td",{className:"text-right px-4",children:e.jsx("button",{type:"button",onClick:()=>de(s),className:"text-gray-300 hover:text-red-600 transition-colors",children:e.jsx(ge,{className:"w-5 h-5"})})})]},s)),r.items.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"py-8 text-center text-gray-400 italic text-sm",children:"Aucun article dans la liste d'achat."})})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 pt-6 border-t-2 border-dashed dark:border-gray-700",children:[e.jsxs("div",{className:"md:col-span-2 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-primary-600",children:"Statut de réception (Actualise le stock)"}),e.jsxs("select",{name:"purchaseStatus",value:r.purchaseStatus,onChange:f,className:`${Y} border-primary-500 ring-2 ring-primary-100`,children:[e.jsx("option",{value:"En attente",children:"En attente (Stock non touché)"}),e.jsx("option",{value:"Commandé",children:"Commandé (Stock non touché)"}),e.jsx("option",{value:"Reçu",children:"Reçu (Stock incrémenté immédiatement)"})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-900/30 p-4 rounded-xl border",children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400 mb-2",children:"Notes administratives"}),e.jsx("textarea",{name:"notes",value:r.notes||"",onChange:f,rows:2,className:m,placeholder:"Conditions particulières, numéro de bon de livraison..."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-black uppercase text-gray-400",children:"Frais d'approche / Livraison"}),e.jsx("input",{type:"number",name:"shippingCost",value:r.shippingCost||"",onChange:f,className:m})]}),e.jsxs("div",{className:"p-5 bg-primary-600 text-white rounded-2xl shadow-xl",children:[e.jsx("h3",{className:"text-xs font-black uppercase opacity-80 tracking-widest",children:"Total de la facture"}),e.jsx("p",{className:"text-3xl font-black mt-1",children:M(r.grandTotal)})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-6",children:[e.jsx("button",{type:"button",onClick:()=>q("/purchases"),className:"px-6 py-3 text-sm font-bold text-gray-500 bg-gray-100 rounded-xl hover:bg-gray-200 uppercase tracking-widest",children:"Annuler"}),e.jsx("button",{type:"submit",disabled:V,className:"px-10 py-3 text-sm text-white bg-primary-600 rounded-xl font-black shadow-lg hover:bg-primary-700 active:scale-95 disabled:opacity-50 uppercase tracking-widest",children:V?"Traitement...":h?"Mettre à jour l'achat":"Enregistrer l'achat"})]})]}),e.jsx(fe,{isOpen:le,onClose:()=>P(!1),title:"Nouveau Fournisseur",children:e.jsxs("form",{onSubmit:ue,className:"p-6 space-y-4",children:[e.jsx("input",{type:"text",placeholder:"Nom de la société",value:i.name||"",onChange:t=>y(s=>({...s,name:t.target.value})),required:!0,className:"w-full border rounded-xl p-3 dark:bg-gray-700"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("input",{type:"text",placeholder:"Contact",value:i.contactPerson||"",onChange:t=>y(s=>({...s,contactPerson:t.target.value})),className:"w-full border rounded-xl p-3 dark:bg-gray-700"}),e.jsx("input",{type:"tel",placeholder:"Téléphone",value:i.phone||"",onChange:t=>y(s=>({...s,phone:t.target.value})),className:"w-full border rounded-xl p-3 dark:bg-gray-700"})]}),e.jsx("input",{type:"email",placeholder:"Email",value:i.email||"",onChange:t=>y(s=>({...s,email:t.target.value})),className:"w-full border rounded-xl p-3 dark:bg-gray-700"}),e.jsx("input",{type:"text",placeholder:"Adresse",value:i.address||"",onChange:t=>y(s=>({...s,address:t.target.value})),className:"w-full border rounded-xl p-3 dark:bg-gray-700"}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>P(!1),className:"px-4 py-2 bg-gray-100 rounded-lg font-bold text-sm uppercase",children:"Annuler"}),e.jsx("button",{type:"submit",disabled:_,className:"bg-primary-600 text-white px-6 py-2 rounded-lg font-black text-sm uppercase shadow-lg",children:_?"Création...":"Ajouter le fournisseur"})]})]})})]})};export{ve as default};
