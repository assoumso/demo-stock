import{t as H,b as J,v as X,r as c,j as e,I as Y,g as I,i as L,d as v,e as u,k as q,x as Z,y as ee}from"./index-szRe9_7c.js";const ae=()=>{const{id:j}=H(),A=J(),S=X(),[r,m]=c.useState({type:"product"}),[F,R]=c.useState([]),[D,T]=c.useState([]),[E,V]=c.useState([]),[$,M]=c.useState([]),[B,z]=c.useState(!0),[P,g]=c.useState(null),[U,C]=c.useState(null),y=!!j;c.useEffect(()=>{(async()=>{var d;try{const[a,n,l,x,p]=await Promise.all([I(v(u,"categories")),I(v(u,"brands")),I(v(u,"units")),I(v(u,"warehouses")),L(q(u,"settings","app-config"))]),h=a.docs.map(s=>({id:s.id,...s.data()}));R(h);const b=n.docs.map(s=>({id:s.id,...s.data()}));T(b);const k=l.docs.map(s=>({id:s.id,...s.data()}));V(k);const w=x.docs.map(s=>({id:s.id,...s.data()}));M(w);const O=p.exists()?p.data():{},Q=w.map(s=>({warehouseId:s.id,quantity:0}));if((d=S.state)!=null&&d.productToDuplicate){const s=S.state.productToDuplicate;m({...s,stockLevels:w.map(o=>{const f=(s.stockLevels||[]).find(N=>N.warehouseId===o.id);return{warehouseId:o.id,quantity:(f==null?void 0:f.quantity)||0}})}),s.imageUrl&&C(s.imageUrl)}else if(y){const s=await L(q(u,"products",j));if(s.exists()){const o=s.data(),f={...o,categoryId:o.categoryId||(h.length>0?h[0].id:""),brandId:o.brandId||(b.length>0?b[0].id:""),unitId:o.unitId||(k.length>0?k[0].id:""),stockLevels:w.map(N=>(o.stockLevels||[]).find(_=>_.warehouseId===N.id)||{warehouseId:N.id,quantity:0})};m(f),o.imageUrl&&C(o.imageUrl)}else g("Produit non trouvé.")}else m({type:"product",name:"",sku:"",imageUrl:"",description:"",upc_ean:"",categoryId:h.length>0?h[0].id:"",brandId:b.length>0?b[0].id:"",unitId:k.length>0?k[0].id:"",cost:0,price:0,minStockAlert:0,taxRate:O.defaultTaxRate||0,taxInclusive:!1,stockLevels:Q})}catch(a){g("Erreur de chargement des données."),console.error(a)}finally{z(!1)}})()},[j,y,S.state]);const i=t=>{const{name:d,value:a}=t.target,n=["price","cost","minStockAlert","wholesalePrice","taxRate"].includes(d);m(l=>({...l,[d]:n?parseFloat(a)||0:a}))},K=()=>{var l,x;const t=((l=r.name)==null?void 0:l.substring(0,3).toUpperCase())||"PROD",d=((x=D.find(p=>p.id===r.brandId))==null?void 0:x.name.substring(0,3).toUpperCase())||"BRA",a=Math.floor(1e3+Math.random()*9e3),n=`${t}-${d}-${a}`;m(p=>({...p,sku:n}))},W=t=>{var a;const d=(a=t.target.files)==null?void 0:a[0];if(d){const n=new FileReader;n.onloadend=()=>{const l=n.result;m(x=>({...x,imageUrl:l})),C(l)},n.readAsDataURL(d)}},G=async t=>{if(t.preventDefault(),g(null),!r.categoryId){g("Veuillez sélectionner une catégorie.");return}if(r.type==="product"&&(!r.brandId||!r.unitId)){g("Veuillez sélectionner une marque et une unité pour un produit physique.");return}try{const{id:d,...a}=r;a.type==="service"&&(a.cost=0,a.price=0,delete a.brandId,delete a.unitId,delete a.minStockAlert,delete a.stockLevels),y?await Z(q(u,"products",j),a):await ee(v(u,"products"),a),A("/products")}catch(d){console.error("Error saving product: ",d),g("Impossible de sauvegarder le produit.")}};return B?e.jsx("div",{className:"text-center p-8",children:"Chargement du formulaire..."}):P?e.jsx("div",{className:"text-center p-8 text-red-500",children:P}):e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-md",children:[e.jsx("h1",{className:"text-xl font-bold text-gray-800 dark:text-white mb-4",children:y?"Modifier l'Article":"Ajouter un Article"}),e.jsxs("form",{onSubmit:G,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Nom de l'article"}),e.jsx("input",{type:"text",name:"name",value:r.name||"",onChange:i,required:!0,className:"mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Type d'article"}),e.jsxs("select",{name:"type",value:r.type,onChange:i,required:!0,className:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:[e.jsx("option",{value:"product",children:"Produit physique"}),e.jsx("option",{value:"service",children:"Service"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Code (SKU)"}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[e.jsx("input",{type:"text",name:"sku",value:r.sku||"",onChange:i,required:!0,className:"block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"}),e.jsx("button",{type:"button",onClick:K,className:"flex-shrink-0 px-3 py-2 text-sm font-medium text-white bg-gray-600 border border-transparent rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Générer"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Catégorie"}),e.jsx("select",{name:"categoryId",value:r.categoryId||"",onChange:i,required:!0,className:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:F.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),r.type==="product"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Marque"}),e.jsx("select",{name:"brandId",value:r.brandId||"",onChange:i,required:r.type==="product",className:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:D.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Unité"}),e.jsx("select",{name:"unitId",value:r.unitId||"",onChange:i,required:r.type==="product",className:"mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white",children:E.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"md:col-span-2 lg:col-span-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Image de l'article"}),e.jsxs("div",{className:"mt-1 flex items-center space-x-4",children:[U?e.jsx("img",{src:U,alt:"Aperçu",className:"h-16 w-16 rounded-md object-cover"}):e.jsx("div",{className:"h-16 w-16 rounded-md bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400",children:e.jsx(Y,{className:"h-8 w-8"})}),e.jsxs("label",{htmlFor:"image-upload",className:"cursor-pointer bg-white dark:bg-gray-700 py-2 px-3 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm leading-4 font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600",children:[e.jsx("span",{children:"Choisir un fichier"}),e.jsx("input",{id:"image-upload",name:"image-upload",type:"file",className:"sr-only",accept:"image/*",onChange:W})]})]})]}),r.type==="product"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Coût d'achat"}),e.jsx("input",{type:"number",step:"any",name:"cost",value:r.cost||"",onChange:i,className:"mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"})]}),r.type==="product"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Prix de vente"}),e.jsx("input",{type:"number",step:"any",name:"price",value:r.price||"",onChange:i,required:!0,className:"mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Taux de TVA (%)"}),e.jsx("input",{type:"number",step:"any",name:"taxRate",value:r.taxRate===void 0?"":r.taxRate,onChange:i,className:"mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"tax-inclusive",name:"tax-type",type:"radio",checked:r.taxInclusive===!0,onChange:()=>m(t=>({...t,taxInclusive:!0})),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"tax-inclusive",className:"ml-2 block text-sm text-gray-900 dark:text-gray-300",children:"TVA Inclus"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"tax-exclusive",name:"tax-type",type:"radio",checked:r.taxInclusive===!1||r.taxInclusive===void 0,onChange:()=>m(t=>({...t,taxInclusive:!1})),className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"}),e.jsx("label",{htmlFor:"tax-exclusive",className:"ml-2 block text-sm text-gray-900 dark:text-gray-300",children:"TVA Exclus"})]})]})}),r.type==="product"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Alerte Stock (Qté min.)"}),e.jsx("input",{type:"number",name:"minStockAlert",value:r.minStockAlert||"",onChange:i,className:"mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"})]})]}),r.type==="product"&&e.jsxs("div",{className:"pt-4 border-t dark:border-gray-700",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-800 dark:text-white",children:"Niveaux de stock par entrepôt"}),e.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Les niveaux de stock initiaux sont gérés via les pages Inventaire et Transferts, et non directement ici."}),e.jsx("div",{className:"mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:$.map(t=>{var d,a;return e.jsxs("div",{children:[e.jsx("label",{htmlFor:`stock-${t.id}`,className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:t.name}),e.jsx("input",{id:`stock-${t.id}`,type:"number",value:((a=(d=r.stockLevels)==null?void 0:d.find(n=>n.warehouseId===t.id))==null?void 0:a.quantity)||0,disabled:!0,className:"mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-gray-300 cursor-not-allowed"})]},t.id)})})]}),e.jsxs("div",{className:"mt-6 flex justify-end space-x-3",children:[e.jsx("button",{type:"button",onClick:()=>A("/products"),className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500",children:"Annuler"}),e.jsx("button",{type:"submit",className:"px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700",children:y?"Sauvegarder":"Créer le produit"})]})]})]})};export{ae as default};
