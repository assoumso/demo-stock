import{u as X,r as n,j as e,T as Y,K as Z,S as ee,f as te,C as se,g as S,d as I,e as D}from"./index-0SUTSTHz.js";const A=new Date;A.setDate(A.getDate()-30);const re=()=>{var O;const{user:p,hasPermission:o}=X(),[y,P]=n.useState("sales"),[_,Q]=n.useState([]),[v,H]=n.useState([]),[C,K]=n.useState([]),[U,z]=n.useState([]),[E,L]=n.useState(!0),[T,W]=n.useState(null),[c,G]=n.useState({startDate:A.toISOString().split("T")[0],endDate:new Date().toISOString().split("T")[0],warehouseId:"all"}),m=n.useMemo(()=>p==null?void 0:p.role.name.toLowerCase().includes("admin"),[p]);n.useEffect(()=>{const t=[];m&&o("reports:profit")&&t.push("profit"),o("reports:sales")&&t.push("sales"),o("reports:services")&&t.push("services"),m&&o("reports:stock_alert")&&t.push("stock_alert"),o("reports:inventory_value")&&t.push("inventory_value"),t.length>0&&!t.includes(y)&&P(t[0])},[p,m,o,y]),n.useEffect(()=>{(async()=>{L(!0),W(null);try{const[s,d,r,i]=await Promise.all([S(I(D,"sales")),S(I(D,"products")),S(I(D,"warehouses")),S(I(D,"customers"))]);Q(s.docs.map(a=>({id:a.id,...a.data()}))),H(d.docs.map(a=>({id:a.id,...a.data()}))),K(r.docs.map(a=>({id:a.id,...a.data()}))),z(i.docs.map(a=>({id:a.id,...a.data()})))}catch(s){console.error("Error fetching report data:",s),W("Impossible de charger les données pour les rapports.")}finally{L(!1)}})()},[]);const g=n.useMemo(()=>p?m?C:C.filter(t=>{var s;return(s=p.warehouseIds)==null?void 0:s.includes(t.id)}):[],[p,C,m]),R=t=>{G(s=>({...s,[t.target.name]:t.target.value}))},x=t=>new Intl.NumberFormat("fr-FR").format(t)+" FCFA",F=t=>new Date(t).toLocaleDateString("fr-FR"),B=n.useMemo(()=>{if(!p)return[];const t=g.map(s=>s.id);return _.filter(s=>t.includes(s.warehouseId))},[p,_,g]),f=n.useMemo(()=>{const t=new Date(c.startDate);t.setHours(0,0,0,0);const s=new Date(c.endDate);return s.setHours(23,59,59,999),B.filter(d=>{const r=new Date(d.date),i=c.warehouseId==="all"||d.warehouseId===c.warehouseId;return r>=t&&r<=s&&i})},[B,c]),V=n.useMemo(()=>{const t=f.reduce((r,i)=>r+i.grandTotal,0),s=f.length,d=s>0?t/s:0;return{totalRevenue:t,salesCount:s,averageSaleValue:d}},[f]),j=n.useMemo(()=>{let t=0,s=0;const d=f.map(a=>{let l=0;for(const N of a.items){const w=v.find(q=>q.id===N.productId);l+=((w==null?void 0:w.cost)||0)*N.quantity}const u=a.grandTotal-l;return t+=a.grandTotal,s+=l,{...a,cogs:l,profit:u}}),r=t-s,i=t>0?r/t*100:0;return{totalRevenue:t,totalCogs:s,totalProfit:r,profitMargin:i,salesWithProfit:d}},[f,v]),$=n.useMemo(()=>v.filter(t=>{var d,r;if(t.type==="service")return!1;let s;if(c.warehouseId==="all"){const i=g.map(a=>a.id);s=(t.stockLevels||[]).filter(a=>i.includes(a.warehouseId)).reduce((a,l)=>a+l.quantity,0)}else s=((r=(d=t.stockLevels)==null?void 0:d.find(i=>i.warehouseId===c.warehouseId))==null?void 0:r.quantity)||0;return s<=t.minStockAlert}),[v,c.warehouseId,g]),M=n.useMemo(()=>{const s=(c.warehouseId==="all"?g:g.filter(r=>r.id===c.warehouseId)).map(r=>{const i=v.filter(a=>a.type!=="service").reduce((a,l)=>{var w;const u=(w=l.stockLevels)==null?void 0:w.find(q=>q.warehouseId===r.id),N=(u==null?void 0:u.quantity)||0;return a+l.cost*N},0);return{warehouseId:r.id,warehouseName:r.name,totalValue:i}});return{totalValue:s.reduce((r,i)=>r+i.totalValue,0),valueByWarehouse:s}},[v,g,c.warehouseId]),b=n.useMemo(()=>{const t={};f.forEach(a=>{a.items.forEach(l=>{const u=v.find(N=>N.id===l.productId);u&&u.type==="service"&&(t[u.id]?(t[u.id].quantity+=l.quantity,t[u.id].revenue+=l.subtotal):t[u.id]={name:u.name,quantity:l.quantity,revenue:l.subtotal})})});const s=Object.values(t).sort((a,l)=>l.revenue-a.revenue),d=s.reduce((a,l)=>a+l.revenue,0),r=s.reduce((a,l)=>a+l.quantity,0),i=s.length>0?s.reduce((a,l)=>a.quantity>l.quantity?a:l):null;return{servicesList:s,totalRevenue:d,totalQuantity:r,mostSoldService:i}},[f,v]),J=t=>{var s;return((s=U.find(d=>d.id===t))==null?void 0:s.name)||"N/A"},h=({title:t,value:s,subtext:d,valueClassName:r})=>e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg shadow",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:t}),e.jsx("p",{className:`text-2xl font-bold ${r||"text-gray-900 dark:text-white"}`,children:s}),d&&e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:d})]}),k=({reportType:t,label:s,icon:d})=>e.jsxs("button",{onClick:()=>P(t),className:`flex items-center space-x-2 px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 ${y===t?"border-primary-500 text-primary-600 dark:text-primary-400":"border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"}`,children:[d,e.jsx("span",{children:s})]});return e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white mb-4",children:"Rapports"}),e.jsx("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Date de début"}),e.jsx("input",{type:"date",name:"startDate",value:c.startDate,onChange:R,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Date de fin"}),e.jsx("input",{type:"date",name:"endDate",value:c.endDate,onChange:R,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Entrepôt"}),e.jsxs("select",{name:"warehouseId",value:c.warehouseId,onChange:R,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700",children:[e.jsx("option",{value:"all",children:"Tous les entrepôts"}),g.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]})}),e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700",children:e.jsxs("nav",{className:"-mb-px flex space-x-6","aria-label":"Tabs",children:[m&&o("reports:profit")&&e.jsx(k,{reportType:"profit",label:"Marge (P&L)",icon:e.jsx(Y,{className:"w-5 h-5"})}),o("reports:sales")&&e.jsx(k,{reportType:"sales",label:"Ventes",icon:e.jsx(Z,{className:"w-5 h-5"})}),o("reports:services")&&e.jsx(k,{reportType:"services",label:"Services",icon:e.jsx(ee,{className:"w-5 h-5"})}),m&&o("reports:stock_alert")&&e.jsx(k,{reportType:"stock_alert",label:"Alertes Stock",icon:e.jsx(te,{className:"w-5 h-5"})}),o("reports:inventory_value")&&e.jsx(k,{reportType:"inventory_value",label:"Valeur du Stock",icon:e.jsx(se,{className:"w-5 h-5"})})]})}),e.jsxs("div",{className:"mt-6",children:[E&&e.jsx("p",{children:"Chargement des données du rapport..."}),T&&e.jsx("p",{className:"text-red-500",children:T}),!E&&!T&&e.jsxs(e.Fragment,{children:[y==="sales"&&o("reports:sales")&&e.jsxs("div",{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6",children:[e.jsx(h,{title:"Revenu Total",value:x(V.totalRevenue)}),e.jsx(h,{title:"Nombre de Ventes",value:V.salesCount}),e.jsx(h,{title:"Vente Moyenne",value:x(V.averageSaleValue)})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Réf."}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Client"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Total"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:f.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4",children:t.referenceNumber}),e.jsx("td",{className:"px-6 py-4",children:J(t.customerId)}),e.jsx("td",{className:"px-6 py-4",children:F(t.date)}),e.jsx("td",{className:"px-6 py-4 text-right",children:x(t.grandTotal)})]},t.id))})]})})]}),m&&y==="profit"&&o("reports:profit")&&e.jsxs("div",{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsx(h,{title:"Revenu Total",value:x(j.totalRevenue)}),e.jsx(h,{title:"Coût Marchandises (CMV)",value:x(j.totalCogs),valueClassName:"text-yellow-600 dark:text-yellow-400"}),e.jsx(h,{title:"Profit Total",value:x(j.totalProfit),valueClassName:j.totalProfit>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}),e.jsx(h,{title:"Marge de Profit",value:`${j.profitMargin.toFixed(2)}%`,valueClassName:j.profitMargin>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Réf."}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Revenu"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Coût"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Profit"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:j.salesWithProfit.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4",children:t.referenceNumber}),e.jsx("td",{className:"px-6 py-4",children:F(t.date)}),e.jsx("td",{className:"px-6 py-4 text-right",children:x(t.grandTotal)}),e.jsx("td",{className:"px-6 py-4 text-right text-yellow-600",children:x(t.cogs)}),e.jsx("td",{className:"px-6 py-4 text-right font-bold text-green-600",children:x(t.profit)})]},t.id))})]})})]}),y==="services"&&o("reports:services")&&e.jsxs("div",{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6",children:[e.jsx(h,{title:"Revenu Total des Services",value:x(b.totalRevenue)}),e.jsx(h,{title:"Nombre de Services Vendus",value:b.totalQuantity}),e.jsx(h,{title:"Service le plus Vendu",value:((O=b.mostSoldService)==null?void 0:O.name)||"N/A",subtext:b.mostSoldService?`${b.mostSoldService.quantity} fois`:""})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Service"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Quantité Vendue"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Revenu Total"})]})}),e.jsxs("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:[b.servicesList.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"text-center py-4",children:"Aucun service vendu pour la période sélectionnée."})}),b.servicesList.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 font-medium",children:t.name}),e.jsx("td",{className:"px-6 py-4 text-right",children:t.quantity}),e.jsx("td",{className:"px-6 py-4 text-right font-semibold",children:x(t.revenue)})]},t.name))]})]})})]}),m&&y==="stock_alert"&&o("reports:stock_alert")&&e.jsx("div",{children:e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Produit"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"SKU"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Stock Actuel"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Niveau d'Alerte"})]})}),e.jsxs("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:[$.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"text-center py-4",children:"Aucun produit en alerte de stock."})}),$.map(t=>{var d,r;let s;if(c.warehouseId==="all"){const i=g.map(a=>a.id);s=(t.stockLevels||[]).filter(a=>i.includes(a.warehouseId)).reduce((a,l)=>a+l.quantity,0)}else s=((r=(d=t.stockLevels)==null?void 0:d.find(i=>i.warehouseId===c.warehouseId))==null?void 0:r.quantity)||0;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 font-medium",children:t.name}),e.jsx("td",{className:"px-6 py-4",children:t.sku}),e.jsx("td",{className:"px-6 py-4 text-right font-bold text-red-500",children:s}),e.jsx("td",{className:"px-6 py-4 text-right",children:t.minStockAlert})]},t.id)})]})]})})}),y==="inventory_value"&&o("reports:inventory_value")&&e.jsxs("div",{children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6",children:e.jsx(h,{title:"Valeur Totale du Stock",value:x(M.totalValue),subtext:"Basé sur le coût d'achat"})}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 shadow rounded-lg overflow-x-auto",children:[e.jsx("h3",{className:"text-lg font-semibold p-4 border-b dark:border-gray-700",children:"Valeur du Stock par Entrepôt"}),e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Entrepôt"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Valeur Totale du Stock"})]})}),e.jsxs("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:[M.valueByWarehouse.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"text-center py-4",children:"Aucune donnée de stock à afficher pour la sélection."})}),M.valueByWarehouse.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t.warehouseName}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right font-medium",children:x(t.totalValue)})]},t.warehouseId))]})]})]})]})]})]})]})};export{re as default};
