import{u as Z,r as o,j as e,q as ee,d as I,e as p,o as te,g as D,l as se,k as z}from"./index-szRe9_7c.js";import{P as ae}from"./Pagination-CsLxWpMj.js";const ne=()=>{const{hasPermission:H}=Z(),[W,V]=o.useState([]),[m,_]=o.useState([]),[x,B]=o.useState([]),[G,C]=o.useState(!0),[P,q]=o.useState(!1),[T,c]=o.useState(null),[i,f]=o.useState({fromWarehouseId:"",toWarehouseId:"",productId:"",quantity:1}),[h,N]=o.useState(""),[d,K]=o.useState({fromWarehouseId:"all",toWarehouseId:"all",productId:"all",startDate:"",endDate:""}),[y,E]=o.useState(1),b=10,L=async()=>{C(!0),c(null);try{const t=ee(I(p,"warehouseTransfers"),te("date","desc")),[s,r,l]=await Promise.all([D(t),D(I(p,"products")),D(I(p,"warehouses"))]);V(s.docs.map(a=>({id:a.id,...a.data()}))),_(r.docs.map(a=>({id:a.id,...a.data()}))),B(l.docs.map(a=>({id:a.id,...a.data()})))}catch(t){c("Impossible de charger les données des transferts."),console.error(t)}finally{C(!1)}};o.useEffect(()=>{L()},[]),o.useEffect(()=>{E(1)},[d]);const w=t=>{const{name:s,value:r}=t.target;f(l=>({...l,[s]:s==="quantity"?parseInt(r)||1:r}))},g=t=>{const{name:s,value:r}=t.target;K(l=>({...l,[s]:r}))},O=(t,s)=>{var l,a;if(!t||!s)return 0;const r=m.find(n=>n.id===t);return((a=(l=r==null?void 0:r.stockLevels)==null?void 0:l.find(n=>n.warehouseId===s))==null?void 0:a.quantity)||0},j=o.useMemo(()=>O(i.productId,i.fromWarehouseId),[i.productId,i.fromWarehouseId,m]),M=o.useMemo(()=>h?m.filter(t=>t.type!=="service"&&(t.name.toLowerCase().includes(h.toLowerCase())||t.sku.toLowerCase().includes(h.toLowerCase()))).slice(0,5):[],[h,m]),U=async t=>{t.preventDefault();const{fromWarehouseId:s,toWarehouseId:r,productId:l,quantity:a}=i;if(!s||!r||!l||a<=0){c("Veuillez remplir tous les champs.");return}if(s===r){c("L'entrepôt de départ et de destination ne peuvent pas être identiques.");return}if(a>j){c("Quantité de transfert supérieure au stock disponible.");return}q(!0),c(null);try{await se(p,async n=>{const F=z(p,"products",l),Q=await n.get(F);if(!Q.exists())throw new Error("Produit non trouvé.");const u=[...Q.data().stockLevels||[]],k=u.findIndex(S=>S.warehouseId===s),R=u.findIndex(S=>S.warehouseId===r);if(k===-1||u[k].quantity<a)throw new Error("Stock insuffisant dans l'entrepôt de départ.");u[k].quantity-=a,R>-1?u[R].quantity+=a:u.push({warehouseId:r,quantity:a}),n.update(F,{stockLevels:u});const Y={date:new Date().toISOString(),fromWarehouseId:s,toWarehouseId:r,productId:l,quantity:a,status:"Complété"};n.set(z(I(p,"warehouseTransfers")),Y)}),await L(),f({fromWarehouseId:"",toWarehouseId:"",productId:"",quantity:1}),N("")}catch(n){c(`Échec du transfert: ${n.message}`)}finally{q(!1)}},A=t=>{var s;return((s=x.find(r=>r.id===t))==null?void 0:s.name)||"N/A"},$=t=>{var s;return((s=m.find(r=>r.id===t))==null?void 0:s.name)||"N/A"},v=o.useMemo(()=>W.filter(t=>{const s=d.fromWarehouseId==="all"||t.fromWarehouseId===d.fromWarehouseId,r=d.toWarehouseId==="all"||t.toWarehouseId===d.toWarehouseId,l=d.productId==="all"||t.productId===d.productId;let a=!0;if(d.startDate){const n=new Date(d.startDate);n.setHours(0,0,0,0),a=a&&new Date(t.date)>=n}if(d.endDate){const n=new Date(d.endDate);n.setHours(23,59,59,999),a=a&&new Date(t.date)<=n}return s&&r&&l&&a}),[W,d]),J=o.useMemo(()=>v.slice((y-1)*b,y*b),[v,y]),X=Math.ceil(v.length/b);return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md h-fit",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Nouveau Transfert"}),H("transfers")?e.jsxs("form",{onSubmit:U,className:"space-y-4",children:[T&&e.jsx("div",{className:"p-3 my-2 text-sm text-red-700 bg-red-100 rounded-md",children:T}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-sm",children:"Produit"}),e.jsx("input",{type:"text",value:h,onChange:t=>{N(t.target.value),i.productId&&f(s=>({...s,productId:""}))},placeholder:"Rechercher un produit par nom ou SKU",required:!i.productId,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700"}),h&&M.length>0&&!i.productId&&e.jsx("ul",{className:"absolute z-10 w-full bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-md mt-1 max-h-48 overflow-y-auto",children:M.map(t=>e.jsxs("li",{className:"p-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700",onClick:()=>{f(s=>({...s,productId:t.id})),N(t.name)},children:[t.name," (",t.sku,")"]},t.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"De (Entrepôt)"}),e.jsxs("select",{name:"fromWarehouseId",value:i.fromWarehouseId,onChange:w,required:!0,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700",children:[e.jsx("option",{value:"",children:"-- Sélectionner --"}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),i.fromWarehouseId&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Stock disponible: ",j]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"À (Entrepôt)"}),e.jsxs("select",{name:"toWarehouseId",value:i.toWarehouseId,onChange:w,required:!0,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700",children:[e.jsx("option",{value:"",children:"-- Sélectionner --"}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Quantité"}),e.jsx("input",{type:"number",name:"quantity",min:"1",max:j>0?j:void 0,value:i.quantity,onChange:w,required:!0,className:"w-full mt-1 border rounded p-2 dark:bg-gray-700"})]}),e.jsx("button",{type:"submit",disabled:P,className:"w-full px-4 py-2 text-white bg-primary-600 rounded-md hover:bg-primary-700 disabled:bg-primary-300",children:P?"Transfert en cours...":"Transférer"})]}):e.jsx("p",{className:"text-sm text-gray-500",children:"Vous n'avez pas la permission d'effectuer des transferts."})]}),e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Historique des transferts"}),e.jsx("div",{className:"mb-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("select",{name:"fromWarehouseId",value:d.fromWarehouseId,onChange:g,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:"all",children:"De: Tous"}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{name:"toWarehouseId",value:d.toWarehouseId,onChange:g,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:"all",children:"À: Tous"}),x.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{name:"productId",value:d.productId,onChange:g,className:"w-full px-3 py-2 border rounded-md dark:bg-gray-700",children:[e.jsx("option",{value:"all",children:"Tous les produits"}),m.filter(t=>t.type!=="service").map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("div",{className:"sm:col-span-2 lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Date début"}),e.jsx("input",{type:"date",name:"startDate",value:d.startDate,onChange:g,className:"w-full mt-1 px-3 py-2 border rounded-md dark:bg-gray-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm",children:"Date fin"}),e.jsx("input",{type:"date",name:"endDate",value:d.endDate,onChange:g,className:"w-full mt-1 px-3 py-2 border rounded-md dark:bg-gray-700"})]})]})]})}),G?e.jsx("p",{children:"Chargement..."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow-md rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-primary-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"Produit"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"De"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-bold text-white uppercase",children:"À"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-bold text-white uppercase",children:"Qté"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:J.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4",children:new Date(t.date).toLocaleDateString()}),e.jsx("td",{className:"px-6 py-4 font-medium",children:$(t.productId)}),e.jsx("td",{className:"px-6 py-4",children:A(t.fromWarehouseId)}),e.jsx("td",{className:"px-6 py-4",children:A(t.toWarehouseId)}),e.jsx("td",{className:"px-6 py-4 text-right",children:t.quantity})]},t.id))})]})}),e.jsx(ae,{currentPage:y,totalPages:X,onPageChange:E,totalItems:v.length,itemsPerPage:b})]})]})]})};export{ne as default};
