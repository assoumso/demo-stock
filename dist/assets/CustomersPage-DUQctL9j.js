import{u as q,b as G,r as n,j as e,D as I,P as H,h as U,f as _,E as z,H as J,m as K,g as D,d as L,e as o,p as Q,k as E,s as V}from"./index-0SUTSTHz.js";import{D as X,a as u}from"./DropdownMenu-DJOgdqBT.js";import{M as Y}from"./Modal-D7o8EM96.js";const se=()=>{const{hasPermission:k}=q(),g=G(),[N,M]=n.useState([]),[x,$]=n.useState({}),[A,v]=n.useState(!0),[C,b]=n.useState(null),[i,p]=n.useState([]),[P,m]=n.useState(!1),[l,f]=n.useState("all"),[h,B]=n.useState(""),y=async()=>{v(!0);try{const[t,s]=await Promise.all([D(L(o,"customers")),D(L(o,"sales"))]),a=t.docs.map(c=>({id:c.id,...c.data()})),r=s.docs.map(c=>c.data()),d={};r.forEach(c=>{const S=c.grandTotal-(c.paidAmount||0);S!==0&&(d[c.customerId]=(d[c.customerId]||0)+S)}),M(a),$(d)}catch{b("Impossible de charger les clients.")}finally{v(!1)}};n.useEffect(()=>{y()},[]);const w=n.useMemo(()=>N.filter(t=>{var r;const s=x[t.id]||0,a=t.name.toLowerCase().includes(h.toLowerCase())||((r=t.businessName)==null?void 0:r.toLowerCase().includes(h.toLowerCase()));return l==="debt"?a&&s>.01:l==="exceeded"?a&&t.isCreditLimited&&t.creditLimit&&s>t.creditLimit:a}),[N,x,l,h]),R=async t=>{if(window.confirm("Supprimer ce client ?"))try{await Q(E(o,"customers",t)),await y()}catch{b("Erreur de suppression.")}},T=async()=>{const t=V(o);i.forEach(s=>t.delete(E(o,"customers",s))),await t.commit(),await y(),p([]),m(!1)},F=t=>{p(s=>s.includes(t)?s.filter(a=>a!==t):[...s,t])},O=t=>{t.target.checked?p(w.map(s=>s.id)):p([])},W=t=>{if(!t.phone){b(`Le client ${t.name} n'a pas de numéro de téléphone.`);return}const s=t.phone.replace(/\D/g,""),a=x[t.id]||0,r=`Bonjour ${t.name}, nous vous contactons concernant votre solde actuel de ${j(a)}. Merci de nous revenir pour régularisation.`,d=`https://wa.me/${s}?text=${encodeURIComponent(r)}`;window.open(d,"_blank","noopener,noreferrer")},j=t=>new Intl.NumberFormat("fr-FR").format(t)+" FCFA";return e.jsxs("div",{className:"pb-10",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-black text-gray-900 dark:text-white uppercase tracking-tight",children:"Gestion des Clients"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"Suivi des comptes et recouvrement des créances."})]}),k("customers")&&e.jsxs("div",{className:"flex items-center space-x-2",children:[i.length>0&&e.jsxs("button",{onClick:()=>m(!0),className:"flex items-center px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 font-bold uppercase text-xs transition-all shadow-lg active:scale-95",children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Supprimer (",i.length,")"]}),e.jsxs("button",{onClick:()=>g("/customers/new"),className:"flex items-center px-6 py-3 bg-primary-600 text-white rounded-xl hover:bg-primary-700 font-black uppercase text-xs shadow-xl transition-all hover:scale-[1.02] active:scale-95",children:[e.jsx(H,{className:"w-5 h-5 mr-2"}),"Nouveau client"]})]})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 p-4 rounded-3xl shadow-xl border border-gray-100 dark:border-gray-700 mb-8 space-y-4",children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4 justify-between",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx("input",{type:"text",placeholder:"Rechercher un client ou une entreprise...",value:h,onChange:t=>B(t.target.value),className:"w-full pl-10 pr-4 py-3 bg-gray-50 dark:bg-gray-900/50 rounded-2xl border-none focus:ring-2 focus:ring-primary-500 font-medium"}),e.jsx("div",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400",children:e.jsx(U,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex bg-gray-100 dark:bg-gray-900 p-1 rounded-2xl self-start",children:[e.jsx("button",{onClick:()=>f("all"),className:`px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${l==="all"?"bg-white dark:bg-gray-800 shadow-md text-primary-600":"text-gray-500"}`,children:"Tous"}),e.jsx("button",{onClick:()=>f("debt"),className:`px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${l==="debt"?"bg-white dark:bg-gray-800 shadow-md text-orange-600":"text-gray-500"}`,children:"Endettés"}),e.jsx("button",{onClick:()=>f("exceeded"),className:`px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${l==="exceeded"?"bg-white dark:bg-gray-800 shadow-md text-red-600":"text-gray-500"}`,children:"Risque Max"})]})]})}),C&&e.jsx("p",{className:"mb-4 text-sm text-red-600 bg-red-100 p-2 rounded-md font-bold text-center",children:C}),A?e.jsx("div",{className:"p-24 text-center text-gray-400 font-black uppercase tracking-widest animate-pulse",children:"Chargement de la base clients..."}):e.jsx("div",{className:"bg-white dark:bg-gray-800 shadow-2xl rounded-3xl border border-gray-100 dark:border-gray-700 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-primary-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-4 w-10 text-center",children:e.jsx("input",{type:"checkbox",onChange:O,className:"h-4 w-4 text-primary-900 border-white rounded focus:ring-0 cursor-pointer"})}),e.jsx("th",{className:"px-6 py-4 text-left text-[10px] font-black text-white uppercase tracking-widest",children:"Identité / Entreprise"}),e.jsx("th",{className:"px-6 py-4 text-left text-[10px] font-black text-white uppercase tracking-widest",children:"Contact"}),e.jsx("th",{className:"px-6 py-4 text-left text-[10px] font-black text-white uppercase tracking-widest",children:"Limite Crédit"}),e.jsx("th",{className:"px-6 py-4 text-right text-[10px] font-black text-white uppercase tracking-widest",children:"Solde Actuel"}),e.jsx("th",{className:"px-6 py-4 text-right text-[10px] font-black text-white uppercase tracking-widest",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-700",children:[w.map(t=>{const s=x[t.id]||0,a=t.isCreditLimited&&t.creditLimit&&s>t.creditLimit,r=s>.01;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors",children:[e.jsx("td",{className:"px-4 py-4 text-center",children:e.jsx("input",{type:"checkbox",checked:i.includes(t.id),onChange:()=>F(t.id),className:"h-4 w-4 text-primary-600 rounded cursor-pointer"})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm font-bold text-gray-900 dark:text-white uppercase tracking-tighter",children:t.name}),t.businessName&&e.jsx("div",{className:"text-[10px] font-black text-gray-400 uppercase tracking-widest",children:t.businessName})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300 font-medium",children:[e.jsx("div",{className:"text-xs font-bold",children:t.phone}),e.jsx("div",{className:"text-[10px] font-bold text-primary-600",children:t.email})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:t.isCreditLimited?e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[9px] font-black text-gray-400 uppercase",children:"Plafond"}),e.jsx("span",{className:"font-black text-gray-700 dark:text-gray-300",children:j(t.creditLimit||0)})]}):e.jsx("span",{className:"text-[9px] text-gray-300 uppercase font-black tracking-widest italic",children:"Sans Limite"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right",children:e.jsxs("div",{className:`inline-flex flex-col items-end px-3 py-1 rounded-xl ${a?"bg-red-600 text-white shadow-lg":r?"bg-orange-50 dark:bg-orange-900/20":"bg-green-50 dark:bg-green-900/20"}`,children:[e.jsxs("div",{className:"flex items-center",children:[a&&e.jsx(_,{className:"w-3 h-3 mr-1 text-white animate-pulse"}),e.jsx("span",{className:`text-sm font-black ${a?"text-white":r?"text-orange-600":"text-green-600"}`,children:j(s)})]}),a&&e.jsx("span",{className:"text-[8px] font-black text-white uppercase tracking-tighter",children:"LIMITE DÉPASSÉE"}),r&&!a&&e.jsx("span",{className:"text-[8px] font-black text-orange-400 uppercase",children:"Dû"})]})}),e.jsx("td",{className:"px-6 py-4 text-right",children:k("customers")&&e.jsxs(X,{children:[e.jsxs(u,{onClick:()=>g(`/customers/account/${t.id}`),children:[e.jsx(z,{className:"w-4 h-4 mr-3 text-blue-500"})," Relevé Compte"]}),e.jsxs(u,{onClick:()=>W(t),children:[e.jsx(J,{className:"w-4 h-4 mr-3 text-green-500"})," Relance WhatsApp"]}),e.jsxs(u,{onClick:()=>g(`/customers/edit/${t.id}`),children:[e.jsx(K,{className:"w-4 h-4 mr-3"})," Modifier Profil"]}),e.jsx("div",{className:"border-t dark:border-gray-700 my-1"}),e.jsxs(u,{onClick:()=>R(t.id),className:"text-red-600 font-bold",children:[e.jsx(I,{className:"w-4 h-4 mr-3"})," Supprimer"]})]})})]},t.id)}),w.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"py-24 text-center text-gray-400 font-black uppercase tracking-widest opacity-30",children:"Aucun client ne correspond à ces critères"})})]})]})})}),e.jsxs(Y,{isOpen:P,onClose:()=>m(!1),title:"Confirmation",children:[e.jsx("div",{className:"p-6",children:e.jsxs("p",{className:"text-sm font-bold text-gray-600",children:["Supprimer définitivement ces ",i.length," profils clients ?"]})}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse",children:[e.jsx("button",{onClick:T,className:"w-full inline-flex justify-center rounded-xl px-6 py-2 bg-red-600 text-xs font-black text-white hover:bg-red-700 sm:ml-3 sm:w-auto uppercase tracking-widest",children:"Confirmer"}),e.jsx("button",{onClick:()=>m(!1),className:"mt-3 w-full inline-flex justify-center rounded-xl px-6 py-2 bg-white text-xs font-black text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto uppercase tracking-widest border",children:"Annuler"})]})]})]})};export{se as default};
